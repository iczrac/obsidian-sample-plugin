# 流时流月问题修复测试

## 问题描述

用户反映两个问题：
1. **流时标题没有正确显示**：流时标题应该显示为 `流时\n14:00` 格式
2. **extend: 1时流月扩展列信息错误**：流月信息计算不正确

## 问题分析

### 1. 流时问题根源
在 `ExtendedColumnManager.ts` 第732行：
```typescript
// 问题代码
hour: this.currentSelectedLiuShi.timeIndex ? this.currentSelectedLiuShi.timeIndex * 2 : undefined

// 问题：当 timeIndex 为 0（子时）时，条件判断失败，导致 hour 为 undefined
```

**修复方案**：
```typescript
// 修复后
hour: this.currentSelectedLiuShi.timeIndex !== undefined ? this.currentSelectedLiuShi.timeIndex * 2 : undefined
```

### 2. 流月问题根源
在 `setCurrentLiuYue` 方法中：
```typescript
// 问题：使用公历月份直接计算流月干支
const solar = Solar.fromYmd(year, month, 1);
```

**修复方案**：
- 使用月中旬（15日）作为参考点
- 获取对应的农历月份信息
- 保存公历和农历月份信息用于标题显示

## 修复内容

### 1. 流时修复
- 修改条件判断：`timeIndex !== undefined` 而不是 `timeIndex`
- 确保子时（timeIndex=0）也能正确处理
- 流时标题格式：`流时\n时间`

### 2. 流月修复
- 使用月中旬作为参考计算农历月份
- 保存公历和农历月份信息
- 流月标题格式：`流月\n公历月份\n农历月份`

## 测试用例

### 测试1：验证流时显示（重点测试子时）
```bazi
date: 1990-01-01 00:30
gender: 男
e: 1
```

**预期结果**：
- 流时标题应显示：`流时\n0:00`
- 不应该是空白或错误格式

### 测试2：验证流时显示（其他时辰）
```bazi
date: 1990-01-01 14:30
gender: 男
e: 1
```

**预期结果**：
- 流时标题应显示：`流时\n14:00`

### 测试3：验证流月信息（extend: 1）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

**预期结果**：
- 流月应该显示正确的农历月份对应的干支
- 流月标题格式：`流月\n公历月份\n农历月份`

### 测试4：验证流月信息（不同月份）
```bazi
date: 1990-06-15 12:00
gender: 男
e: 3
```

**预期结果**：
- 流月信息应该正确对应6月份的农历月份
- 干支计算应该准确

### 测试5：验证完整时间层级
```bazi
date: 1990-01-01 00:00
gender: 男
e: 1
```

**预期结果**：
- 大运：正确显示
- 流年：正确显示
- 流月：正确的农历月份干支
- 流日：正确显示
- 流时：`流时\n0:00`（子时）

## 验证要点

### 1. 流时验证
- [ ] 子时（0:00）能正确显示
- [ ] 其他时辰能正确显示
- [ ] 标题格式为 `流时\n时间`
- [ ] 不再出现空白或undefined

### 2. 流月验证
- [ ] 流月干支计算正确
- [ ] 使用农历月份而非公历月份
- [ ] 标题显示公历农历对应关系
- [ ] extend: 1 时流月信息正确

### 3. 整体验证
- [ ] 所有扩展列标题格式正确
- [ ] 时间信息准确无误
- [ ] 农历公历对应关系正确
- [ ] 控制台无错误日志

## 技术细节

### 1. timeIndex 处理
```typescript
// 时辰索引对应表
// 0: 子时 (23:00-01:00)
// 1: 丑时 (01:00-03:00)
// ...
// 11: 亥时 (21:00-23:00)

// 转换为标准时间
const standardTime = timeIndex * 2; // 子时=0, 丑时=2, ...
```

### 2. 农历月份计算
```typescript
// 使用月中旬作为参考点
const solar = Solar.fromYmd(year, month, 15);
const lunar = solar.getLunar();

// 获取农历月份信息
const lunarYear = lunar.getYear();
const lunarMonth = lunar.getMonth();
```

### 3. 数据结构更新
```typescript
this.currentSelectedLiuYue = {
  year: lunarYear,        // 农历年份
  month: lunarMonth,      // 农历月份
  solarYear: year,        // 公历年份
  solarMonth: month,      // 公历月份
  ganZhi,                 // 干支
  name: `${ganZhi}月`     // 名称
};
```

## 预期改进

修复后应该能够：
1. 正确显示所有时辰的流时信息
2. 准确计算流月的农历干支
3. 提供正确的时间对应关系
4. 消除extend: 1时的流月错误

如果仍有问题，请检查控制台日志中的详细计算过程。
