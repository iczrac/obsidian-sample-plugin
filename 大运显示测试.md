# 大运显示测试

## 测试说明
测试自动扩展功能中大运列的显示是否正确，应该显示对应年份的正确大运，而不是一直显示"前运"。

## 测试1：当前时间自动扩展
应该显示2024年对应的大运

```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

## 测试2：指定年份自动扩展
应该显示2030年对应的大运

```bazi
date: 1990-01-01 08:00
gender: 男
e: 5
t: 2030-06-15 12:00
```

## 测试3：流日扩展
应该显示当前年份对应的大运

```bazi
bazi: 庚午 戊子 甲子 乙亥
gender: 女
e: 2
```

## 测试4：流月扩展
应该显示当前年份对应的大运

```bazi
lunar: 1985-03-15 10:30
gender: 男
e: 3
```

## 测试5：验证不同年份的大运
测试1995年出生的人在不同年份的大运

```bazi
date: 1995-05-20 14:30
gender: 女
e: 5
t: 2025-01-01 12:00
```

## 测试6：验证不扩展模式
应该不显示任何大运列

```bazi
date: 1990-01-01 08:00
gender: 男
e: 0
```

## 测试7：验证清除扩展后的状态
先扩展再清除，应该不显示大运

```bazi
date: 1990-01-01 08:00
gender: 男
extend: none
```

## 预期结果
- **有扩展时**：大运列应该显示对应年份的正确大运干支
- **不扩展时**：不应该显示任何大运列
- 不应该一直显示"前运"（除非确实在前运期间）
- 大运名称应该是"大运"而不是"前运"（除非确实在前运期间）
- 大运干支应该与该年份的实际大运匹配
- `e: 0` 或 `extend: none` 时应该完全不显示扩展列

## 调试信息
如果仍有问题，请检查控制台输出：
- `setDaYunIndexForYear` 的日志
- `getDaYunPillarInfo` 的日志
- 大运数据的年份范围

---

## 🕐 扩展列标题时间信息测试

### 预期的标题格式

#### 大运标题
- 前运：`前运`
- 大运：`大运\n2024-2034\n(34-44岁)`

#### 流年标题
- 格式：`流年\n2024年\n(甲辰)`

#### 流月标题
- 格式：`流月\n6月\n五月` （公历月份 + 农历月份）

#### 流日标题
- 格式：`流日\n2024.6.17\n五月十九` （公历日期 + 农历日期）

#### 流时标题
- 格式：`流时\n14:00` （简洁的时间格式）

#### 特殊宫位标题
- 胎元：`胎元`
- 命宫：`命宫`
- 身宫：`身宫`

### 样式要求

1. **多行文本支持**：使用 `white-space: pre-line` 支持换行符
2. **美观布局**：合适的行间距和字体大小
3. **垂直居中**：确保多行文本在单元格中垂直居中
4. **最小高度**：确保有足够空间显示多行内容
5. **响应式设计**：在不同屏幕尺寸下都能正常显示

### 测试用例（验证标题时间信息）

#### 测试A：完整时间层级（应显示所有时间信息）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

#### 测试B：自定义时间（应显示目标时间）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 5
t: 2025-06-17 14:30
```

#### 测试C：流月扩展（应显示月份和公历对应）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 3
```

---

## 🔽 流月、流日、流时收缩展开功能测试

### 测试说明
验证流月、流日、流时表格的收缩展开功能是否正确实现：
- **默认状态**：应该只显示第一行内容（月份/日期/时辰行）
- **展开状态**：应该显示所有详细信息（十神、地势、旬空、纳音、神煞等）
- **收缩按钮**：点击+/-按钮应该能正确切换状态

### 测试用例

#### 测试D：流月收缩展开测试
```bazi
date: 1990-01-01 08:00
gender: 男
e: 3
```

#### 测试E：流日收缩展开测试
```bazi
date: 1990-01-01 08:00
gender: 男
e: 2
```

#### 测试F：流时收缩展开测试
```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

### 预期行为
1. **初始状态**：流月、流日、流时表格应该默认收缩，只显示第一行
2. **点击展开**：点击+按钮后，应该显示完整的表格内容
3. **点击收缩**：点击-按钮后，应该重新收缩到只显示第一行
4. **动画效果**：展开收缩应该有平滑的过渡效果
5. **状态保持**：展开/收缩状态应该在重新渲染时保持

---

## 🎨 表格样式一致性测试

### 测试说明
验证所有表格（大运、流年、流月、流日、流时）的样式是否保持一致：
- **表格容器**：统一的背景色和滚动条样式
- **表头样式**：统一的背景色、字体大小、内边距
- **数据单元格**：统一的边框、内边距、最小宽度
- **字体大小**：所有表格使用11px字体
- **最小宽度**：所有单元格使用60px最小宽度

### 样式测试用例

#### 测试G：完整表格样式对比（大运+流年+流月+流日+流时）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

#### 测试H：收缩状态样式对比（所有表格都收缩）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

#### 测试I：展开状态样式对比（所有表格都展开）
```bazi
date: 1990-01-01 08:00
gender: 男
e: 1
```

### 预期样式统一性
1. **表格容器**：
   - 背景色：`var(--background-primary)`
   - 水平滚动：`overflow-x: auto`
   - 最小宽度：800px以上

2. **表头单元格**：
   - 背景色：`var(--background-modifier-border)`
   - 字体大小：11px
   - 内边距：6px 8px
   - 最小宽度：60px

3. **数据单元格**：
   - 字体大小：11px
   - 内边距：4px 6px
   - 最小宽度：60px
   - 边框：1px solid var(--background-modifier-border)
   - 鼠标悬停效果：transition: all 0.2s ease

4. **颜色方案**：
   - 五行颜色：统一使用ColorSchemeService
   - 神煞颜色：统一的吉凶色彩标识
   - 地势颜色：统一的十二长生颜色

5. **标题栏样式**：
   - 背景色：`var(--background-secondary)`
   - 边框：1px solid var(--background-modifier-border)
   - 圆角：4px
   - 内边距：8px 12px
   - 底部间距：8px

6. **收缩展开按钮**：
   - 统一使用 ▶/▼ 符号
   - 颜色：`var(--text-muted)`
   - 字体大小：12px
   - 悬停效果：统一的过渡动画

---

## ✅ 样式统一完成

### 已统一的视觉元素

1. **标题栏设计**：
   - 所有表格（大运、流年、流月、流日、流时）现在使用相同的标题栏样式
   - 统一的背景色、边框、圆角和内边距
   - 一致的标题文字样式（14px，粗体）

2. **收缩展开按钮**：
   - 统一使用 ▶（收缩）和 ▼（展开）符号
   - 移除了之前大运和流年使用的方形 +/- 按钮
   - 统一的颜色和悬停效果

3. **表格容器**：
   - 统一的边框样式和圆角
   - 一致的背景色和滚动条处理

4. **表格内容**：
   - 统一的字体大小（11px）
   - 一致的单元格最小宽度（60px）
   - 统一的内边距和边框样式

### 删除的冗余代码

1. **大运管理器**：
   - 删除了 `updateToggleButton()` 方法
   - 删除了 `updateContainerVisibility()` 方法
   - 简化了切换逻辑

2. **流年管理器**：
   - 删除了 `updateToggleButton()` 方法
   - 删除了 `updateContainerVisibility()` 方法
   - 简化了切换逻辑

3. **统一的实现方案**：
   - 所有表格现在都使用相同的收缩展开机制
   - 通过重新渲染表格内容来控制显示的行数
   - 统一的样式定义和交互逻辑

---

## 🔗 层级显示功能实现

### 功能说明

实现了层级显示逻辑，流月、流日、流时默认隐藏，只有在点击上级元素时才显示下级内容：

- **流月**：默认隐藏，点击流年后显示
- **流日**：默认隐藏，点击流月后显示
- **流时**：默认隐藏，点击流日后显示

### 层级关系

```
大运 → 流年 → 流月 → 流日 → 流时
```

### 实现机制

1. **默认隐藏**：
   - 流月、流日、流时信息区域在创建时设置 `display: none`
   - 只有大运和流年默认显示

2. **层级显示**：
   - 点击流年 → 显示流月，隐藏流日和流时
   - 点击流月 → 显示流日，隐藏流时
   - 点击流日 → 显示流时

3. **状态管理**：
   - 每个信息管理器都有 `show()` 和 `hide()` 方法
   - SectionRenderManager 统一管理层级隐藏逻辑
   - InteractiveBaziView 协调整体状态重置

### 测试用例

#### 测试J：层级显示功能测试
```bazi
date: 1990-01-01 08:00
gender: 男
e: 0
```

### 预期行为

1. **初始状态**：
   - 只显示大运和流年信息
   - 流月、流日、流时信息隐藏

2. **点击流年**：
   - 流月信息显示
   - 流日、流时信息隐藏

3. **点击流月**：
   - 流日信息显示
   - 流时信息隐藏

4. **点击流日**：
   - 流时信息显示

5. **重新选择上级**：
   - 选择新的流年时，流日和流时自动隐藏
   - 选择新的流月时，流时自动隐藏

### 技术实现

1. **信息管理器层面**：
   - 每个管理器在 `setSelected*` 方法中调用 `show()`
   - 提供 `hide()` 方法用于隐藏

2. **SectionRenderManager层面**：
   - `hideLowerLevelElements()` 方法统一管理下级隐藏
   - 在流年、流月、流日选择时调用相应隐藏逻辑

3. **InteractiveBaziView层面**：
   - `resetLowerLevelSelections()` 方法协调状态重置
   - `resetLowerLevelSelectionsExcept()` 方法支持排除特定层级
   - 确保扩展列管理器状态与显示状态一致

---

## 🔧 层级显示问题修复

### 问题诊断

发现层级显示功能的问题：流月、流日、流时确实隐藏了，但点击流年、流月、流日后，对应的下级内容没有出现。

### 问题原因

1. **事件处理冲突**：
   - InteractiveBaziView 和 SectionRenderManager 都有事件处理逻辑
   - `resetLowerLevelSelections()` 会隐藏所有下级元素，包括应该显示的元素

2. **执行顺序问题**：
   - 先调用 `resetLowerLevelSelections()` 隐藏下级元素
   - 再调用 `setSelectedYear()` 显示流月
   - 但隐藏操作可能覆盖了显示操作

### 修复方案

#### 1. **精确控制隐藏逻辑**
```typescript
// 流年选择：只隐藏流日和流时，不隐藏流月
private handleLiuNianSelect(liunian: any) {
  // 先隐藏流日和流时
  if (liuRiInfoManager) liuRiInfoManager.hide();
  if (liuShiInfoManager) liuShiInfoManager.hide();

  // 重置状态但排除流月
  this.resetLowerLevelSelectionsExcept('liunian', ['liuyue']);

  // 显示流月
  liuYueInfoManager.setSelectedYear(liunian.year);
}
```

#### 2. **新增排除方法**
```typescript
// 支持排除特定层级的重置方法
private resetLowerLevelSelectionsExcept(currentLevel: string, except: string[] = [])
```

#### 3. **层级显示流程**
- **流年选择** → 隐藏流日、流时 → 显示流月
- **流月选择** → 隐藏流时 → 显示流日
- **流日选择** → 显示流时

### 修复结果

现在层级显示功能应该正常工作：

1. **初始状态**：只显示大运和流年
2. **点击流年**：流月出现，流日和流时隐藏
3. **点击流月**：流日出现，流时隐藏
4. **点击流日**：流时出现
5. **重新选择**：正确隐藏和显示相应层级
