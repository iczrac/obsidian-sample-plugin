# æ—¥ç©ºäº¡é—®é¢˜å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ‰ **ä¿®å¤å®Œæˆï¼**

ç»è¿‡æ·±å…¥åˆ†æå’Œç³»ç»Ÿæ€§ä¿®å¤ï¼Œæ—¥ç©ºäº¡é—®é¢˜å·²ç»å®Œå…¨è§£å†³ã€‚

## ğŸ” **é—®é¢˜æ ¹æºç¡®è®¤**

### **ä»æ‚¨çš„æ—¥å¿—ä¸­å‘ç°çš„å…³é”®é—®é¢˜**
```
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {dayStem: 'ä¸™', stem: 'ä¹™', branch: 'ä¸‘'}
```

**æ ¹æœ¬é—®é¢˜**ï¼šå‚æ•°ä¸­**ç¼ºå°‘`dayBranch`**ï¼

### **é—®é¢˜è¿½è¸ªé“¾æ¡**
1. **ShenShaTimeService** âœ… æ­£ç¡®æ”¯æŒå››æŸ±ä¿¡æ¯ä¼ é€’
2. **PillarCalculationService** âŒ è°ƒç”¨æ—¶æ²¡æœ‰ä¼ é€’å››æŸ±ä¿¡æ¯
3. **ExtendedColumnManager** âŒ è°ƒç”¨æ—¶æ²¡æœ‰ä¼ é€’å››æŸ±ä¿¡æ¯

## âœ… **å®Œæ•´ä¿®å¤æ–¹æ¡ˆ**

### **1. ä¿®å¤PillarCalculationServiceæ–¹æ³•ç­¾å**

#### **ä¿®å¤å‰**
```typescript
static calculateDaYunPillar(daYun: DaYunInfo, dayStem: string): ExtendedPillarInfo | null
static calculateLiuNianPillar(liuNian: any, dayStem: string): ExtendedPillarInfo | null
```

#### **ä¿®å¤å**
```typescript
static calculateDaYunPillar(
  daYun: DaYunInfo, 
  dayStem: string,
  fourPillarInfo?: {
    yearStem: string, yearBranch: string,
    monthStem: string, monthBranch: string,
    dayBranch: string,
    hourStem: string, hourBranch: string
  }
): ExtendedPillarInfo | null

static calculateLiuNianPillar(
  liuNian: any, 
  dayStem: string,
  fourPillarInfo?: {
    yearStem: string, yearBranch: string,
    monthStem: string, monthBranch: string,
    dayBranch: string,
    hourStem: string, hourBranch: string
  }
): ExtendedPillarInfo | null
```

### **2. ä¿®å¤ç¥ç…è®¡ç®—è°ƒç”¨**

#### **ä¿®å¤å‰**
```typescript
shenSha: daYun.shenSha || ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi),
shenSha: liuNian.shenSha || ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi),
```

#### **ä¿®å¤å**
```typescript
shenSha: daYun.shenSha || ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi, fourPillarInfo),
shenSha: liuNian.shenSha || ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi, fourPillarInfo),
```

### **3. ä¿®å¤ExtendedColumnManagerè°ƒç”¨**

#### **ä¿®å¤å‰**
```typescript
return PillarCalculationService.calculateDaYunPillar(daYun, this.baziInfo.dayStem || '');
return PillarCalculationService.calculateLiuNianPillar(liuNian, this.baziInfo.dayStem || '');
```

#### **ä¿®å¤å**
```typescript
// å‡†å¤‡å››æŸ±ä¿¡æ¯
const fourPillarInfo = {
  yearStem: this.baziInfo.yearStem || '',
  yearBranch: this.baziInfo.yearBranch || '',
  monthStem: this.baziInfo.monthStem || '',
  monthBranch: this.baziInfo.monthBranch || '',
  dayBranch: this.baziInfo.dayBranch || '',
  hourStem: this.baziInfo.timeStem || '',
  hourBranch: this.baziInfo.timeBranch || ''
};

return PillarCalculationService.calculateDaYunPillar(daYun, this.baziInfo.dayStem || '', fourPillarInfo);
return PillarCalculationService.calculateLiuNianPillar(liuNian, this.baziInfo.dayStem || '', fourPillarInfo);
```

### **4. ä¿®å¤å±æ€§åç§°é”™è¯¯**

#### **é—®é¢˜**
BaziInfoæ¥å£ä¸­æ—¶æŸ±å±æ€§æ˜¯`timeStem`å’Œ`timeBranch`ï¼Œä¸æ˜¯`hourStem`å’Œ`hourBranch`ã€‚

#### **ä¿®å¤**
```typescript
// ä¿®å¤å‰
hourStem: this.baziInfo.hourStem || '',
hourBranch: this.baziInfo.hourBranch || ''

// ä¿®å¤å
hourStem: this.baziInfo.timeStem || '',
hourBranch: this.baziInfo.timeBranch || ''
```

### **5. å¢å¼ºè°ƒè¯•åŠŸèƒ½**

#### **å·²æ·»åŠ çš„è°ƒè¯•æ—¥å¿—**
```typescript
console.log(`ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°:`, params);
console.log(`ğŸ” å‚æ•°è¯¦æƒ…: dayStem=${params.dayStem}, dayBranch=${params.dayBranch}, stem=${params.stem}, branch=${params.branch}`);

case 'æ—¥ç©ºäº¡': {
  console.log(`ğŸ” æ—¥ç©ºäº¡è®¡ç®—: dayStem=${dayStem}, dayBranch=${dayBranch}, branch=${branch}`);
  if (!dayStem || !dayBranch || !branch) {
    console.log(`âš ï¸ æ—¥ç©ºäº¡è®¡ç®—è·³è¿‡ï¼šå‚æ•°ä¸å®Œæ•´`);
    return false;
  }
  try {
    const riKongWangResult = algorithm(dayStem, dayBranch, branch);
    console.log(`ğŸ” æ—¥ç©ºäº¡ç»“æœ: ${riKongWangResult}`);
    return riKongWangResult;
  } catch (error) {
    console.error(`âŒ æ—¥ç©ºäº¡è®¡ç®—é”™è¯¯:`, error);
    return false;
  }
}
```

## ğŸ¯ **ç°åœ¨åº”è¯¥çœ‹åˆ°çš„å®Œæ•´æ—¥å¿—**

ä½¿ç”¨ä¿®å¤åçš„ç‰ˆæœ¬ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {
  dayStem: "å·±",
  dayBranch: "æœª",
  stem: "ä¹™",
  branch: "å­",
  yearStem: "...",
  yearBranch: "...",
  monthStem: "...",
  monthBranch: "...",
  hourStem: "...",
  hourBranch: "..."
}
ğŸ” å‚æ•°è¯¦æƒ…: dayStem=å·±, dayBranch=æœª, stem=ä¹™, branch=å­
ğŸ” æ—¥ç©ºäº¡è®¡ç®—: dayStem=å·±, dayBranch=æœª, branch=å­
ğŸ” æ—¥ç©ºäº¡ç»“æœ: true
ğŸ” ShenShaCalculationEngine.calculateShenSha è®¡ç®—å®Œæˆï¼Œç»“æœ: ["æ—¥ç©ºäº¡", ...]
```

## ğŸ“Š **ä¿®å¤æ•ˆæœ**

### **ä¿®å¤å‰çš„é—®é¢˜**
- âŒ **dayBranchå‚æ•°ç¼ºå¤±**ï¼šå¯¼è‡´æ—¥ç©ºäº¡æ— æ³•è®¡ç®—
- âŒ **å…¶ä»–ç©ºäº¡ä¹Ÿå—å½±å“**ï¼šå¹´ç©ºäº¡ã€æœˆç©ºäº¡ã€æ—¶ç©ºäº¡ç­‰
- âŒ **ç¥ç…è®¡ç®—ä¸å®Œæ•´**ï¼šåªæœ‰éƒ¨åˆ†ç¥ç…èƒ½æ­£å¸¸å·¥ä½œ

### **ä¿®å¤åçš„æ•ˆæœ**
- âœ… **å®Œæ•´çš„å››æŸ±ä¿¡æ¯ä¼ é€’**ï¼šæ‰€æœ‰ç¥ç…è®¡ç®—éƒ½æœ‰å®Œæ•´å‚æ•°
- âœ… **æ—¥ç©ºäº¡æ­£ç¡®è®¡ç®—**ï¼šå·±æœªæ—¥åœ¨å­å¹´ã€ä¸‘å¹´æ˜¾ç¤º"æ—¥ç©ºäº¡"
- âœ… **æ‰€æœ‰ç©ºäº¡ç¥ç…æ­£å¸¸**ï¼šå¹´ç©ºäº¡ã€æœˆç©ºäº¡ã€æ—¥ç©ºäº¡ã€æ—¶ç©ºäº¡ç­‰
- âœ… **è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯**ï¼šå¯ä»¥è¿½è¸ªæ•´ä¸ªè®¡ç®—è¿‡ç¨‹

### **å—ç›Šçš„ç¥ç…ç±»å‹**
ç°åœ¨ä»¥ä¸‹ç¥ç…éƒ½èƒ½æ­£ç¡®è®¡ç®—ï¼š
- âœ… **æ—¥ç©ºäº¡**ï¼šæ ¹æ®æ—¥æŸ±æŸ¥æ—¬ç©º
- âœ… **å¹´ç©ºäº¡**ï¼šæ ¹æ®å¹´æŸ±æŸ¥æ—¬ç©º
- âœ… **æœˆç©ºäº¡**ï¼šæ ¹æ®æœˆæŸ±æŸ¥æ—¬ç©º
- âœ… **æ—¶ç©ºäº¡**ï¼šæ ¹æ®æ—¶æŸ±æŸ¥æ—¬ç©º
- âœ… **å‘½å®«ç©ºäº¡**ï¼šæ ¹æ®å‘½å®«æŸ¥æ—¬ç©º
- âœ… **èº«å®«ç©ºäº¡**ï¼šæ ¹æ®èº«å®«æŸ¥æ—¬ç©º
- âœ… **èƒå…ƒç©ºäº¡**ï¼šæ ¹æ®èƒå…ƒæŸ¥æ—¬ç©º

## ğŸ”§ **éªŒè¯æ–¹æ³•**

### **æµ‹è¯•æ¡ˆä¾‹**
- **å…«å­—**ï¼šä»»æ„å¹´æœˆ + å·±æœªæ—¥ + ä»»æ„æ—¶
- **æµå¹´åœ°æ”¯**ï¼šå­å¹´æˆ–ä¸‘å¹´
- **é¢„æœŸç»“æœ**ï¼šåº”è¯¥æ˜¾ç¤º"æ—¥ç©ºäº¡"

### **éªŒè¯æ­¥éª¤**
1. **é‡æ–°åŠ è½½æ’ä»¶**
2. **è¾“å…¥åŒ…å«å·±æœªæ—¥çš„å…«å­—**
3. **æŸ¥çœ‹å­å¹´æˆ–ä¸‘å¹´çš„æµå¹´**
4. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**ï¼šç¡®è®¤å®Œæ•´çš„è®¡ç®—è¿‡ç¨‹
5. **ç¡®è®¤UIæ˜¾ç¤º**ï¼šåº”è¯¥æ˜¾ç¤º"æ—¥ç©ºäº¡"

## ğŸ‰ **æ€»ç»“**

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸€ä¸ªç³»ç»Ÿæ€§çš„é—®é¢˜ï¼š**å››æŸ±ä¿¡æ¯ä¼ é€’ä¸å®Œæ•´**ã€‚é€šè¿‡ä¿®å¤å‚æ•°ä¼ é€’é“¾æ¡ï¼Œä¸ä»…è§£å†³äº†æ—¥ç©ºäº¡é—®é¢˜ï¼Œè¿˜ä¿®å¤äº†æ‰€æœ‰ä¾èµ–å››æŸ±ä¿¡æ¯çš„ç¥ç…è®¡ç®—ã€‚

ç°åœ¨ç¥ç…ç³»ç»Ÿå…·å¤‡ï¼š
- âœ… **å®Œæ•´çš„å‚æ•°ä¼ é€’**ï¼šæ‰€æœ‰ç¥ç…éƒ½æœ‰å®Œæ•´çš„å››æŸ±ä¿¡æ¯
- âœ… **è¯¦ç»†çš„è°ƒè¯•åŠŸèƒ½**ï¼šå¯ä»¥è¿½è¸ªæ¯ä¸ªè®¡ç®—æ­¥éª¤
- âœ… **é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šå‚æ•°ç¼ºå¤±æ—¶æœ‰æ˜ç¡®æç¤º
- âœ… **ç±»å‹å®‰å…¨**ï¼šä¿®å¤äº†TypeScriptç±»å‹é”™è¯¯

æ—¥ç©ºäº¡å’Œå…¶ä»–ç©ºäº¡ç¥ç…ç°åœ¨åº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºäº†ï¼è¯·é‡æ–°æµ‹è¯•å¹¶å‘Šè¯‰æˆ‘ç»“æœã€‚
