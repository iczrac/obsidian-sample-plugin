import { BaziInfo } from '../../../types/BaziInfo';
import { StyleUtilsService } from '../../../services/bazi/StyleUtilsService';
import { ColorSchemeService } from '../../../services/bazi/ColorSchemeService';
import { DataGenerationService } from '../../../services/bazi/DataGenerationService';

/**
 * ÊµÅÊúà‰ø°ÊÅØÁÆ°ÁêÜÂô®
 * Ë¥üË¥£ÂàõÂª∫ÂíåÁÆ°ÁêÜÊµÅÊúà‰ø°ÊÅØÁöÑÊ®™ÂêëËØ¶ÁªÜË°®Ê†ºÊòæÁ§∫
 */
export class LiuYueInfoManager {
  private container: HTMLElement;
  private baziInfo: BaziInfo;
  private plugin?: any;
  private onLiuYueSelect?: (liuyue: any) => void;
  private selectedYear: number = 0;
  private isExpanded: boolean = false; // ÈªòËÆ§Êî∂Ëµ∑
  private liuYueSection: HTMLElement | null = null;
  private infoContainer: HTMLElement | null = null;
  private toggleButton: HTMLElement | null = null;

  constructor(container: HTMLElement, baziInfo: BaziInfo, plugin?: any, onLiuYueSelect?: (liuyue: any) => void) {
    this.container = container;
    this.baziInfo = baziInfo;
    this.plugin = plugin;
    this.onLiuYueSelect = onLiuYueSelect;
  }

  /**
   * ÂàõÂª∫ÊµÅÊúà‰ø°ÊÅØÂå∫Âüü
   */
  createLiuYueInfo(): HTMLElement {
    this.liuYueSection = this.container.createDiv({ cls: 'bazi-view-section bazi-liuyue-info' });

    // ÈªòËÆ§ÈöêËóèÔºåÁ≠âÂæÖÊµÅÂπ¥ÈÄâÊã©
    this.liuYueSection.style.display = 'none';

    // ÂàõÂª∫Ê†áÈ¢ò
    this.createHeader();

    // ÂàõÂª∫‰ø°ÊÅØÂÆπÂô®
    this.createInfoContainer();

    // Ê∑ªÂä†ÊµÅÊúà‰ø°ÊÅØ
    this.addLiuYueInfo();

    return this.liuYueSection;
  }

  /**
   * ÂàõÂª∫Ê†áÈ¢ò
   */
  private createHeader() {
    if (!this.liuYueSection) return;

    const header = this.liuYueSection.createDiv({ cls: 'bazi-liuyue-info-header' });
    header.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--background-secondary);
      border: 1px solid var(--background-modifier-border);
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    `;

    // Ê†áÈ¢òÊñáÊú¨
    const titleText = header.createEl('span', { 
      text: 'ÊµÅÊúà‰ø°ÊÅØ',
      cls: 'bazi-liuyue-info-title'
    });
    titleText.style.cssText = `
      font-weight: bold;
      color: var(--text-normal);
      font-size: 14px;
    `;

    // ÂàáÊç¢ÊåâÈíÆ
    this.toggleButton = header.createEl('span', { 
      text: this.isExpanded ? '‚ñº' : '‚ñ∂',
      cls: 'bazi-liuyue-info-toggle'
    });
    this.toggleButton.style.cssText = `
      color: var(--text-muted);
      font-size: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    `;

    // ÁÇπÂáª‰∫ã‰ª∂
    header.addEventListener('click', () => {
      this.toggle();
    });

    // ÊÇ¨ÂÅúÊïàÊûú
    this.toggleButton.addEventListener('mouseenter', () => {
      this.toggleButton!.style.background = 'var(--background-modifier-hover)';
      this.toggleButton!.style.color = 'var(--text-normal)';
    });

    this.toggleButton.addEventListener('mouseleave', () => {
      this.toggleButton!.style.background = 'transparent';
      this.toggleButton!.style.color = 'var(--text-muted)';
    });
  }

  /**
   * ÂàõÂª∫‰ø°ÊÅØÂÆπÂô®
   */
  private createInfoContainer() {
    if (!this.liuYueSection) return;

    this.infoContainer = this.liuYueSection.createDiv({ cls: 'bazi-liuyue-info-container' });
    this.infoContainer.style.cssText = `
      display: block;
      border: 1px solid var(--background-modifier-border);
      border-radius: 4px;
      overflow: hidden;
    `;
  }

  /**
   * ÂàáÊç¢Â±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅ
   */
  private toggle() {
    this.isExpanded = !this.isExpanded;

    if (this.toggleButton) {
      this.toggleButton.textContent = this.isExpanded ? '‚ñº' : '‚ñ∂';
    }

    // ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†º‰ª•ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜ‰ø°ÊÅØ
    setTimeout(() => {
      this.reRenderTable();
    }, 150); // Á≠âÂæÖÂä®ÁîªÂÆåÊàê‰∏ÄÂçäÊó∂ÈáçÊñ∞Ê∏≤Êüì

    console.log(`üéØ ÊµÅÊúà‰ø°ÊÅØÊ†è${this.isExpanded ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑'}`);
  }

  /**
   * Ê∑ªÂä†ÊµÅÊúà‰ø°ÊÅØ
   */
  private addLiuYueInfo() {
    if (!this.infoContainer) return;

    if (this.selectedYear === 0) {
      this.infoContainer.createEl('div', {
        text: 'ËØ∑ÈÄâÊã©ÊµÅÂπ¥Êü•ÁúãÂØπÂ∫îÊµÅÊúà',
        cls: 'bazi-empty-message'
      }).style.cssText = `
        padding: 20px;
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
      `;
      return;
    }

    // ÂàõÂª∫ÊµÅÊúàË°®Ê†º
    this.createLiuYueTable();
  }

  /**
   * ÂàõÂª∫ÊµÅÊúàË°®Ê†º
   */
  private createLiuYueTable() {
    if (!this.infoContainer || this.selectedYear === 0) return;

    // Ê∏ÖÁ©∫ÂÆπÂô®
    this.infoContainer.empty();

    // ÁîüÊàêÊµÅÊúàÊï∞ÊçÆ
    const liuYueData = this.generateLiuYueData(this.selectedYear);
    
    if (!liuYueData || liuYueData.length === 0) {
      this.infoContainer.createEl('div', {
        text: `${this.selectedYear}Âπ¥Êó†ÊµÅÊúàÊï∞ÊçÆ`,
        cls: 'bazi-empty-message'
      }).style.cssText = `
        padding: 20px;
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
      `;
      return;
    }

    // ÂàõÂª∫Ë°®Ê†ºÂÆπÂô®
    const tableContainer = this.infoContainer.createDiv({ cls: 'bazi-liuyue-table-container' });
    tableContainer.style.cssText = `
      overflow-x: auto;
      background: var(--background-primary);
    `;

    // ÂàõÂª∫Ë°®Ê†º
    const table = tableContainer.createEl('table', { cls: 'bazi-view-table bazi-liuyue-table' });
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 800px;
    `;

    // ÂàõÂª∫Ë°®Ê†ºÂÜÖÂÆπ
    this.createLiuYueTableContent(table, liuYueData);
  }

  /**
   * ÂàõÂª∫ÊµÅÊúàË°®Ê†ºÂÜÖÂÆπ
   */
  private createLiuYueTableContent(table: HTMLElement, liuYueData: any[]) {
    // Ê∏ÖÁ©∫Ë°®Ê†º
    table.empty();

    // ÂßãÁªàÊòæÁ§∫ÁöÑË°åÔºöÊúà‰ªΩË°åÔºàÂåÖÂê´Âπ≤ÊîØÔºâ
    this.createMonthRow(table, liuYueData);

    // Â±ïÂºÄÊó∂ÊòæÁ§∫ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
    if (this.isExpanded) {
      this.createShiShenRow(table, liuYueData);
      this.createDiShiRow(table, liuYueData);
      this.createXunKongRow(table, liuYueData);
      this.createNaYinRow(table, liuYueData);
      this.createShenShaRow(table, liuYueData);
    }
  }

  /**
   * ÁîüÊàêÊµÅÊúàÊï∞ÊçÆ
   */
  private generateLiuYueData(year: number): any[] {
    try {
      // Ëé∑ÂèñÊó•Âπ≤Áî®‰∫éËÆ°ÁÆóÂçÅÁ•û
      const dayStem = this.baziInfo.dayStem || 'Áî≤';

      // ‰ΩøÁî®Êï∞ÊçÆÁîüÊàêÊúçÂä°ÔºàÁªü‰∏ÄÂêéÁ´ØÁÆóÊ≥ïÔºâ
      const liuYueData = DataGenerationService.generateLiuYueForYear(year, dayStem);
      console.log(`üéØ ÁîüÊàê${year}Âπ¥ÊµÅÊúàÊï∞ÊçÆ:`, liuYueData);
      return liuYueData;
    } catch (error) {
      console.error('‚ùå ÁîüÊàêÊµÅÊúàÊï∞ÊçÆÂ§±Ë¥•:', error);

      // ËøîÂõûÁÆÄÂåñÁöÑÂ§áÁî®Êï∞ÊçÆ
      const months = ['Ê≠£Êúà', '‰∫åÊúà', '‰∏âÊúà', 'ÂõõÊúà', '‰∫îÊúà', 'ÂÖ≠Êúà', '‰∏ÉÊúà', 'ÂÖ´Êúà', '‰πùÊúà', 'ÂçÅÊúà', 'ÂçÅ‰∏ÄÊúà', 'ÂçÅ‰∫åÊúà'];

      return months.map((month, index) => ({
        year,
        month: index + 1,
        name: month,
        ganZhi: 'Áî≤ÂØÖ', // ÁÆÄÂåñ
        shiShen: 'ÊØîËÇ©',
        diShi: 'ÈïøÁîü',
        xunKong: ['Êàå', '‰∫•'],
        naYin: '',
        shenSha: [],
        startDate: `${index + 1}.1`,
        isBackup: true
      }));
    }
  }

  /**
   * ÂàõÂª∫Êúà‰ªΩË°åÔºàÊï¥ÂêàÊó•ÊúüÂíåÂπ≤ÊîØÊòæÁ§∫Ôºâ
   */
  private createMonthRow(table: HTMLElement, liuYueData: any[]) {
    const row = table.createEl('tr', { cls: 'bazi-liuyue-month-row' });
    row.createEl('th', { text: 'ÊµÅÊúà' }).style.cssText = this.getHeaderCellStyle();

    liuYueData.forEach((ly) => {
      const cell = row.createEl('td', {
        cls: 'bazi-liuyue-cell',
        attr: { 'data-month': ly.month.toString() }
      });
      cell.style.cssText = this.getDataCellStyle();

      // ÂàõÂª∫Êï¥ÂêàÊòæÁ§∫ÔºöÊó•ÊúüÊç¢Ë°åÂπ≤ÊîØÔºàÂ¶ÇÔºö5.6Êç¢Ë°å‰πôÂçØÔºâ
      const dateDiv = cell.createDiv({ cls: 'month-date' });
      dateDiv.textContent = ly.startDate || `${ly.month}.1`;
      dateDiv.style.cssText = `
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.2;
        margin-bottom: 2px;
      `;

      // Ê∑ªÂä†Âπ≤ÊîØÊòæÁ§∫
      const ganZhiDiv = cell.createDiv({ cls: 'month-ganzhi' });
      if (ly.ganZhi) {
        ColorSchemeService.createColoredGanZhiElement(ganZhiDiv, ly.ganZhi);
      } else {
        ganZhiDiv.textContent = ly.ganZhi || '';
      }
      ganZhiDiv.style.cssText = `
        font-size: 12px;
        font-weight: bold;
        line-height: 1.2;
      `;

      // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
      cell.addEventListener('click', () => this.selectLiuYue(ly));
    });
  }



  /**
   * ÂàõÂª∫ÂçÅÁ•ûË°åÔºàÂèÇËÄÉÊµÅÂπ¥ÂÆûÁé∞Ôºâ
   */
  private createShiShenRow(table: HTMLElement, liuYueData: any[]) {
    if (!liuYueData.some(ly => ly.shiShenGan || ly.shiShenZhi)) return;

    const row = table.createEl('tr', { cls: 'bazi-liuyue-shishen-row' });
    row.createEl('th', { text: 'ÂçÅÁ•û' }).style.cssText = this.getHeaderCellStyle();

    liuYueData.forEach((ly) => {
      const cell = row.createEl('td', {
        cls: 'bazi-liuyue-cell'
      });
      cell.style.cssText = this.getDataCellStyle() + 'line-height: 1.2;';

      // Â§©Âπ≤ÂçÅÁ•û
      if (ly.shiShenGan) {
        const ganShiShen = cell.createDiv({
          text: ly.shiShenGan,
          cls: 'bazi-shishen-gan'
        });
        ganShiShen.style.cssText = `
          font-size: 10px;
          margin-bottom: 1px;
          font-weight: bold;
        `;
        ColorSchemeService.setShiShenColor(ganShiShen, ly.shiShenGan);
      }

      // Âú∞ÊîØÂçÅÁ•û
      if (ly.shiShenZhi) {
        const zhiShiShenText = Array.isArray(ly.shiShenZhi) ? ly.shiShenZhi.join(' ') : ly.shiShenZhi;
        const zhiShiShen = cell.createDiv({
          text: zhiShiShenText,
          cls: 'bazi-shishen-zhi'
        });
        zhiShiShen.style.cssText = `
          font-size: 9px;
          opacity: 0.8;
        `;
        ColorSchemeService.setShiShenColor(zhiShiShen, zhiShiShenText.split(' ')[0]);
      }

      cell.addEventListener('click', () => this.selectLiuYue(ly));
    });
  }

  /**
   * ÂàõÂª∫Âú∞ÂäøË°å
   */
  private createDiShiRow(table: HTMLElement, liuYueData: any[]) {
    // ÊÄªÊòØÂàõÂª∫Âú∞ÂäøË°åÔºåÊîØÊåÅÂä®ÊÄÅËÆ°ÁÆó

    const row = table.createEl('tr', { cls: 'bazi-liuyue-dishi-row' });

    // ÂàõÂª∫ÂèØÁÇπÂáªÁöÑÂú∞ÂäøÊ†áÁ≠æ
    const headerCell = row.createEl('th', {
      text: 'Âú∞Âäø',
      cls: 'bazi-changsheng-label'
    });
    headerCell.style.cssText = this.getHeaderCellStyle() + 'cursor: pointer;';
    headerCell.setAttribute('title', 'Êó•Âπ≤Âú®ÂêÑÂú∞ÊîØÁöÑÂçÅ‰∫åÈïøÁîüÁä∂ÊÄÅ (ÁÇπÂáªÂàáÊç¢)');

    liuYueData.forEach((ly) => {
      const cell = row.createEl('td', {
        text: ly.diShi || '',
        cls: 'bazi-liuyue-cell'
      });
      cell.style.cssText = this.getDataCellStyle();
      if (ly.diShi) {
        ColorSchemeService.setDiShiColor(cell, ly.diShi);
      }
      cell.addEventListener('click', () => this.selectLiuYue(ly));
    });
  }

  /**
   * ÂàõÂª∫Êó¨Á©∫Ë°åÔºàÂèÇËÄÉÊµÅÂπ¥ÂÆûÁé∞Ôºâ
   */
  private createXunKongRow(table: HTMLElement, liuYueData: any[]) {
    if (!liuYueData.some(ly => ly.xunKong)) return;

    const row = table.createEl('tr', { cls: 'bazi-liuyue-xunkong-row' });
    row.createEl('th', { text: 'Êó¨Á©∫' }).style.cssText = this.getHeaderCellStyle();

    liuYueData.forEach((ly) => {
      const cell = row.createEl('td', { cls: 'bazi-liuyue-cell' });
      cell.style.cssText = this.getDataCellStyle();

      // Â§ÑÁêÜÊó¨Á©∫Âπ≤ÊîØÈ¢úËâ≤ÊòæÁ§∫
      if (ly.xunKong) {
        ColorSchemeService.createColoredXunKongElement(cell, ly.xunKong);
      } else {
        cell.textContent = '';
      }

      cell.addEventListener('click', () => this.selectLiuYue(ly));
    });
  }

  /**
   * ÂàõÂª∫Á∫≥Èü≥Ë°å
   */
  private createNaYinRow(table: HTMLElement, liuYueData: any[]) {
    if (!liuYueData.some(ly => ly.naYin)) return;

    const row = table.createEl('tr', { cls: 'bazi-liuyue-nayin-row' });
    row.createEl('th', { text: 'Á∫≥Èü≥' }).style.cssText = this.getHeaderCellStyle();

    liuYueData.forEach((ly) => {
      const cell = row.createEl('td', {
        text: ly.naYin || '',
        cls: 'bazi-liuyue-cell'
      });
      cell.style.cssText = this.getDataCellStyle();
      if (ly.naYin) {
        ColorSchemeService.setNaYinColor(cell, ly.naYin);
      }
      cell.addEventListener('click', () => this.selectLiuYue(ly));
    });
  }

  /**
   * ÂàõÂª∫Á•ûÁÖûË°å
   */
  private createShenShaRow(table: HTMLElement, liuYueData: any[]) {
    if (!liuYueData.some(ly => ly.shenSha && ly.shenSha.length > 0)) return;

    const row = table.createEl('tr', { cls: 'bazi-liuyue-shensha-row' });
    row.createEl('th', { text: 'Á•ûÁÖû' }).style.cssText = this.getHeaderCellStyle();

    liuYueData.forEach((ly) => {
      const cell = row.createEl('td', { cls: 'bazi-liuyue-cell' });
      cell.style.cssText = this.getDataCellStyle();
      
      if (ly.shenSha && ly.shenSha.length > 0) {
        ly.shenSha.forEach((shenSha: string, index: number) => {
          if (index > 0) {
            cell.createSpan({ text: ' ' });
          }

          const shenShaSpan = cell.createSpan({
            text: shenSha,
            cls: 'shensha-tag'
          });

          // Ê∑ªÂä†Á•ûÁÖûÊ†∑Âºè
          ColorSchemeService.setShenShaColor(shenShaSpan, shenSha);

          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
          shenShaSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            this.handleShenShaClick(shenSha);
          });
        });
      } else {
        cell.textContent = '';
      }

      cell.addEventListener('click', () => this.selectLiuYue(ly));
    });
  }

  /**
   * ÈÄâÊã©ÊµÅÊúà
   */
  private selectLiuYue(liuyue: any) {
    console.log(`üéØ ÊµÅÊúàÈÄâÊã©: ${liuyue.month}Êúà (${liuyue.ganZhi})`);

    // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊµÅÊúà
    this.highlightSelectedLiuYue(liuyue.month);

    // Ë∞ÉÁî®ÂõûË∞ÉÂáΩÊï∞
    if (this.onLiuYueSelect) {
      this.onLiuYueSelect(liuyue);
    }

    // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂
    const event = new CustomEvent('liuyue-select', {
      detail: { liuyue },
      bubbles: true
    });
    this.container.dispatchEvent(event);
  }

  /**
   * È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊµÅÊúà
   */
  private highlightSelectedLiuYue(month: number) {
    if (!this.infoContainer) return;

    const cells = this.infoContainer.querySelectorAll('.bazi-liuyue-cell');
    cells.forEach((cell) => {
      const cellMonth = parseInt(cell.getAttribute('data-month') || '0');
      if (cellMonth === month) {
        cell.classList.add('selected');
      } else {
        cell.classList.remove('selected');
      }
    });
  }

  /**
   * Â§ÑÁêÜÁ•ûÁÖûÁÇπÂáª‰∫ã‰ª∂
   */
  private handleShenShaClick(shenSha: string) {
    console.log(`üéØ ÊµÅÊúàÁ•ûÁÖûË¢´ÁÇπÂáª: ${shenSha}`);

    // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂ÔºåËÆ©Áà∂ÁªÑ‰ª∂Â§ÑÁêÜ
    const event = new CustomEvent('shensha-click', {
      detail: { shenSha },
      bubbles: true
    });
    this.container.dispatchEvent(event);
  }

  /**
   * Ëé∑ÂèñË°®Â§¥ÂçïÂÖÉÊ†ºÊ†∑Âºè
   */
  private getHeaderCellStyle(): string {
    return `
      padding: 6px 8px;
      background: var(--background-modifier-border);
      border: 1px solid var(--background-modifier-border);
      font-weight: bold;
      text-align: center;
      font-size: 11px;
      color: var(--text-normal);
      min-width: 60px;
    `;
  }

  /**
   * Ëé∑ÂèñÊï∞ÊçÆÂçïÂÖÉÊ†ºÊ†∑Âºè
   */
  private getDataCellStyle(): string {
    return `
      padding: 4px 6px;
      border: 1px solid var(--background-modifier-border);
      text-align: center;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
    `;
  }

  /**
   * ËÆæÁΩÆÈÄâ‰∏≠ÁöÑÂπ¥‰ªΩ
   */
  setSelectedYear(year: number) {
    console.log(`üéØ LiuYueInfoManager: ËÆæÁΩÆÂπ¥‰ªΩ ${year}`);
    this.selectedYear = year;

    // ÊòæÁ§∫ÊµÅÊúàÂå∫Âüü
    this.show();

    // Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂ÈáçÊñ∞ÂàõÂª∫ÊµÅÊúàË°®Ê†º
    if (this.infoContainer) {
      this.infoContainer.empty();
      this.addLiuYueInfo();
    }
  }

  /**
   * ÊòæÁ§∫ÊµÅÊúà‰ø°ÊÅØÂå∫Âüü
   */
  show() {
    if (this.liuYueSection) {
      this.liuYueSection.style.display = 'block';
    }
  }

  /**
   * ÈöêËóèÊµÅÊúà‰ø°ÊÅØÂå∫Âüü
   */
  hide() {
    if (this.liuYueSection) {
      this.liuYueSection.style.display = 'none';
    }
  }

  /**
   * Êõ¥Êñ∞ÂÖ´Â≠ó‰ø°ÊÅØ
   */
  updateBaziInfo(baziInfo: BaziInfo) {
    this.baziInfo = baziInfo;

    // ÈáçÊñ∞ÂàõÂª∫ÂÜÖÂÆπ
    if (this.infoContainer) {
      this.addLiuYueInfo();
    }
  }

  /**
   * Ëé∑ÂèñÊµÅÊúà‰ø°ÊÅØÂå∫ÂüüÂÖÉÁ¥†
   */
  getLiuYueSection(): HTMLElement | null {
    return this.liuYueSection;
  }

  /**
   * ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†ºÔºàÂú®Â±ïÂºÄ/Êî∂Ëµ∑Êó∂Ë∞ÉÁî®Ôºâ
   */
  private reRenderTable() {
    if (!this.infoContainer || this.selectedYear === 0) return;

    const table = this.infoContainer.querySelector('.bazi-liuyue-table') as HTMLElement;
    if (table) {
      const liuYueData = this.generateLiuYueData(this.selectedYear);
      if (liuYueData && liuYueData.length > 0) {
        this.createLiuYueTableContent(table, liuYueData);
      }
    }
  }
}
