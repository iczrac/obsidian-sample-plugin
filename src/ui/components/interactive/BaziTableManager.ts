import { BaziInfo } from '../../../types/BaziInfo';
import { BaziCalculator } from '../../../services/bazi/BaziCalculator';
import { ShiShenCalculator } from '../../../services/bazi/ShiShenCalculator';
import { BaziUtils } from '../../../services/bazi/BaziUtils';
import { ColorSchemeService } from '../../../services/bazi/ColorSchemeService';

/**
 * ÂÖ´Â≠óË°®Ê†ºÁÆ°ÁêÜÂô®
 * Ë¥üË¥£ÂàõÂª∫ÂíåÁÆ°ÁêÜ‰∏ªË¶ÅÁöÑÂÖ´Â≠óË°®Ê†º
 */
export class BaziTableManager {
  private container: HTMLElement;
  private baziInfo: BaziInfo;
  private baziTable: HTMLTableElement | null = null;

  constructor(container: HTMLElement, baziInfo: BaziInfo) {
    this.container = container;
    this.baziInfo = baziInfo;
  }

  /**
   * ÂàõÂª∫ÂÖ´Â≠óË°®Ê†º
   */
  createBaziTable(): HTMLTableElement {
    const tableSection = this.container.createDiv({ cls: 'bazi-view-section' });

    // Ê∑ªÂä†Âü∫Êú¨‰ø°ÊÅØÔºàÂÖ¨ÂéÜ„ÄÅÂÜúÂéÜ„ÄÅÊÄßÂà´Ôºâ
    const basicInfoDiv = tableSection.createDiv({ cls: 'bazi-basic-info' });

    if (this.baziInfo.solarDate) {
      basicInfoDiv.createSpan({
        text: `ÂÖ¨ÂéÜ: ${this.baziInfo.solarDate} ${this.baziInfo.solarTime || ''}`,
        cls: 'bazi-basic-info-item'
      });
    }

    if (this.baziInfo.lunarDate) {
      basicInfoDiv.createSpan({
        text: `ÂÜúÂéÜ: ${this.baziInfo.lunarDate}`,
        cls: 'bazi-basic-info-item'
      });
    }

    if (this.baziInfo.gender) {
      basicInfoDiv.createSpan({
        text: `ÊÄßÂà´: ${this.baziInfo.gender === '1' ? 'Áî∑' : 'Â•≥'}`,
        cls: 'bazi-basic-info-item'
      });
    }

    // ÂàõÂª∫Ë°®Ê†º
    const table = tableSection.createEl('table', { cls: 'bazi-view-table' });
    this.baziTable = table;

    // ÂàõÂª∫Ë°®Â§¥
    this.createTableHeader(table);

    // ÂàõÂª∫Ë°®‰Ωì
    this.createTableBody(table);

    return table;
  }

  /**
   * ÂàõÂª∫Ë°®Â§¥
   */
  private createTableHeader(table: HTMLTableElement) {
    const thead = table.createEl('thead');
    const headerRow = thead.createEl('tr');

    // Ê∑ªÂä†Â∑¶‰æßÊ†áÈ¢òÊ†è
    headerRow.createEl('th', { text: '‰ø°ÊÅØ', cls: 'bazi-table-label' });

    // Ê∑ªÂä†ÂõõÊü±Ë°®Â§¥
    ['Âπ¥Êü±', 'ÊúàÊü±', 'Êó•Êü±', 'Êó∂Êü±'].forEach(text => {
      headerRow.createEl('th', { text });
    });
  }

  /**
   * ÂàõÂª∫Ë°®‰Ωì
   */
  private createTableBody(table: HTMLTableElement) {
    const tbody = table.createEl('tbody');

    // ÂàõÂª∫ÂêÑË°å
    this.createStemRow(tbody);
    this.createBranchRow(tbody);
    this.createHideGanRow(tbody);
    this.createShiShenRow(tbody);
    this.createDiShiRow(tbody);
    this.createNaYinRow(tbody);
    this.createXunKongRow(tbody);
    this.createShengXiaoRow(tbody);
    this.createShenShaRow(tbody);
  }

  /**
   * ÂàõÂª∫Â§©Âπ≤Ë°å
   */
  private createStemRow(tbody: HTMLElement) {
    const stemRow = tbody.createEl('tr', { cls: 'bazi-stem-row' });
    stemRow.createEl('td', { text: 'Â§©Âπ≤', cls: 'bazi-table-label' });

    // Â§©Âπ≤Ë°å - Áõ¥Êé•Âú®tdÂÖÉÁ¥†‰∏äËÆæÁΩÆÈ¢úËâ≤
    const yearStemCell = stemRow.createEl('td', { text: this.baziInfo.yearStem || '' });
    this.applyStemWuXingColor(yearStemCell, this.baziInfo.yearStem || '');

    const monthStemCell = stemRow.createEl('td', { text: this.baziInfo.monthStem || '' });
    this.applyStemWuXingColor(monthStemCell, this.baziInfo.monthStem || '');

    const dayStemCell = stemRow.createEl('td', { text: this.baziInfo.dayStem || '' });
    this.applyStemWuXingColor(dayStemCell, this.baziInfo.dayStem || '');

    const timeStemCell = stemRow.createEl('td', { text: this.baziInfo.timeStem || '' });
    this.applyStemWuXingColor(timeStemCell, this.baziInfo.timeStem || '');
  }

  /**
   * ÂàõÂª∫Âú∞ÊîØË°å
   */
  private createBranchRow(tbody: HTMLElement) {
    const branchRow = tbody.createEl('tr', { cls: 'bazi-branch-row' });
    branchRow.createEl('td', { text: 'Âú∞ÊîØ', cls: 'bazi-table-label' });

    // Âú∞ÊîØË°å - Áõ¥Êé•Âú®tdÂÖÉÁ¥†‰∏äËÆæÁΩÆÈ¢úËâ≤
    const yearBranchCell = branchRow.createEl('td', { text: this.baziInfo.yearBranch || '' });
    this.applyBranchWuXingColor(yearBranchCell, this.baziInfo.yearBranch || '');

    const monthBranchCell = branchRow.createEl('td', { text: this.baziInfo.monthBranch || '' });
    this.applyBranchWuXingColor(monthBranchCell, this.baziInfo.monthBranch || '');

    const dayBranchCell = branchRow.createEl('td', { text: this.baziInfo.dayBranch || '' });
    this.applyBranchWuXingColor(dayBranchCell, this.baziInfo.dayBranch || '');

    const timeBranchCell = branchRow.createEl('td', { text: this.baziInfo.timeBranch || '' });
    this.applyBranchWuXingColor(timeBranchCell, this.baziInfo.timeBranch || '');
  }

  /**
   * ÂàõÂª∫ËóèÂπ≤Ë°å
   */
  private createHideGanRow(tbody: HTMLElement) {
    const hideGanRow = tbody.createEl('tr', { cls: 'bazi-hidegan-row' });
    hideGanRow.createEl('td', { text: 'ËóèÂπ≤', cls: 'bazi-table-label' });

    // Âπ¥Êü±ËóèÂπ≤
    const yearHideGanText = Array.isArray(this.baziInfo.yearHideGan) ? this.baziInfo.yearHideGan.join('') : (this.baziInfo.yearHideGan || '');
    const yearHideGanCell = hideGanRow.createEl('td');
    this.createColoredHideGan(yearHideGanCell, yearHideGanText);

    // ÊúàÊü±ËóèÂπ≤
    const monthHideGanText = Array.isArray(this.baziInfo.monthHideGan) ? this.baziInfo.monthHideGan.join('') : (this.baziInfo.monthHideGan || '');
    const monthHideGanCell = hideGanRow.createEl('td');
    this.createColoredHideGan(monthHideGanCell, monthHideGanText);

    // Êó•Êü±ËóèÂπ≤
    const dayHideGanText = Array.isArray(this.baziInfo.dayHideGan) ? this.baziInfo.dayHideGan.join('') : (this.baziInfo.dayHideGan || '');
    const dayHideGanCell = hideGanRow.createEl('td');
    this.createColoredHideGan(dayHideGanCell, dayHideGanText);

    // Êó∂Êü±ËóèÂπ≤
    const timeHideGanText = Array.isArray(this.baziInfo.timeHideGan) ? this.baziInfo.timeHideGan.join('') : (this.baziInfo.timeHideGan || '');
    const timeHideGanCell = hideGanRow.createEl('td');
    this.createColoredHideGan(timeHideGanCell, timeHideGanText);
  }

  /**
   * ÂàõÂª∫ÂçÅÁ•ûË°å
   */
  private createShiShenRow(tbody: HTMLElement) {
    const shiShenRow = tbody.createEl('tr', { cls: 'bazi-shishen-row' });
    shiShenRow.createEl('td', { text: 'ÂçÅÁ•û', cls: 'bazi-table-label' });

    // Ë∞ÉËØïÔºöÊ£ÄÊü•ÂçÅÁ•ûÊï∞ÊçÆ
    console.log('üîçüîçüîç BaziTableManager ÂçÅÁ•ûÊï∞ÊçÆÊ£ÄÊü•ÂºÄÂßã üîçüîçüîç');
    console.log('yearShiShenGan:', this.baziInfo.yearShiShenGan);
    console.log('monthShiShenGan:', this.baziInfo.monthShiShenGan);
    console.log('dayShiShen:', this.baziInfo.dayShiShen);
    console.log('dayShiShenGan:', this.baziInfo.dayShiShenGan);
    console.log('timeShiShenGan:', this.baziInfo.timeShiShenGan);
    console.log('üîçüîçüîç BaziTableManager ÂçÅÁ•ûÊï∞ÊçÆÊ£ÄÊü•ÁªìÊùü üîçüîçüîç');

    // Âπ¥Êü±ÂçÅÁ•û
    const yearShiShenCell = shiShenRow.createEl('td');
    // Â§©Âπ≤ÂçÅÁ•û
    if (this.baziInfo.yearShiShenGan) {
      const yearShiShenSpan = yearShiShenCell.createSpan({
        text: this.baziInfo.yearShiShenGan,
        cls: 'shishen-tag-small'
      });
      this.applyShiShenColor(yearShiShenSpan, this.baziInfo.yearShiShenGan);
    }
    // Êç¢Ë°å
    yearShiShenCell.createEl('br');
    // Âú∞ÊîØËóèÂπ≤ÂçÅÁ•û
    if (this.baziInfo.yearShiShenZhi && Array.isArray(this.baziInfo.yearShiShenZhi) && this.baziInfo.yearShiShenZhi.length > 0) {
      const yearShiShenZhiSpan = yearShiShenCell.createSpan({
        text: this.baziInfo.yearShiShenZhi.join(','),
        cls: 'shishen-tag-small shishen-tag-hide'
      });
      // ‰∏∫ËóèÂπ≤ÂçÅÁ•û‰πüÂ∫îÁî®È¢úËâ≤Ôºà‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂçÅÁ•ûÁöÑÈ¢úËâ≤Ôºâ
      if (this.baziInfo.yearShiShenZhi.length > 0) {
        this.applyShiShenColor(yearShiShenZhiSpan, this.baziInfo.yearShiShenZhi[0]);
      }
    }

    // ÊúàÊü±ÂçÅÁ•û
    const monthShiShenCell = shiShenRow.createEl('td');
    if (this.baziInfo.monthShiShenGan) {
      const monthShiShenSpan = monthShiShenCell.createSpan({
        text: this.baziInfo.monthShiShenGan,
        cls: 'shishen-tag-small'
      });
      this.applyShiShenColor(monthShiShenSpan, this.baziInfo.monthShiShenGan);
    }
    monthShiShenCell.createEl('br');
    if (this.baziInfo.monthShiShenZhi && Array.isArray(this.baziInfo.monthShiShenZhi) && this.baziInfo.monthShiShenZhi.length > 0) {
      const monthShiShenZhiSpan = monthShiShenCell.createSpan({
        text: this.baziInfo.monthShiShenZhi.join(','),
        cls: 'shishen-tag-small shishen-tag-hide'
      });
      if (this.baziInfo.monthShiShenZhi.length > 0) {
        this.applyShiShenColor(monthShiShenZhiSpan, this.baziInfo.monthShiShenZhi[0]);
      }
    }

    // Êó•Êü±ÂçÅÁ•û
    const dayShiShenCell = shiShenRow.createEl('td');
    // ‰ºòÂÖà‰ΩøÁî®dayShiShenÔºàÂ∫îËØ•ÊòØ"Êó•‰∏ª"ÔºâÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®dayShiShenGan
    const dayShiShenText = this.baziInfo.dayShiShen || this.baziInfo.dayShiShenGan || 'Êó•‰∏ª';
    const dayShiShenSpan = dayShiShenCell.createSpan({
      text: dayShiShenText,
      cls: 'shishen-tag-small'
    });
    this.applyShiShenColor(dayShiShenSpan, dayShiShenText);
    dayShiShenCell.createEl('br');
    if (this.baziInfo.dayShiShenZhi && Array.isArray(this.baziInfo.dayShiShenZhi) && this.baziInfo.dayShiShenZhi.length > 0) {
      const dayShiShenZhiSpan = dayShiShenCell.createSpan({
        text: this.baziInfo.dayShiShenZhi.join(','),
        cls: 'shishen-tag-small shishen-tag-hide'
      });
      if (this.baziInfo.dayShiShenZhi.length > 0) {
        this.applyShiShenColor(dayShiShenZhiSpan, this.baziInfo.dayShiShenZhi[0]);
      }
    }

    // Êó∂Êü±ÂçÅÁ•û
    const timeShiShenCell = shiShenRow.createEl('td');
    if (this.baziInfo.timeShiShenGan) {
      const timeShiShenSpan = timeShiShenCell.createSpan({
        text: this.baziInfo.timeShiShenGan,
        cls: 'shishen-tag-small'
      });
      this.applyShiShenColor(timeShiShenSpan, this.baziInfo.timeShiShenGan);
    }
    timeShiShenCell.createEl('br');
    if (this.baziInfo.timeShiShenZhi && Array.isArray(this.baziInfo.timeShiShenZhi) && this.baziInfo.timeShiShenZhi.length > 0) {
      const timeShiShenZhiSpan = timeShiShenCell.createSpan({
        text: this.baziInfo.timeShiShenZhi.join(','),
        cls: 'shishen-tag-small shishen-tag-hide'
      });
      if (this.baziInfo.timeShiShenZhi.length > 0) {
        this.applyShiShenColor(timeShiShenZhiSpan, this.baziInfo.timeShiShenZhi[0]);
      }
    }
  }

  /**
   * ÂàõÂª∫Âú∞ÂäøË°å
   */
  private createDiShiRow(tbody: HTMLElement) {
    const diShiRow = tbody.createEl('tr', { cls: 'bazi-dishi-row' });

    // ÂàõÂª∫ÂèØÁÇπÂáªÁöÑÊ†áÁ≠æ
    const labelCell = diShiRow.createEl('td', { cls: 'bazi-table-label bazi-changsheng-label' });
    labelCell.textContent = 'Âú∞Âäø';
    labelCell.setAttribute('title', 'Êó•Âπ≤Âú®ÂêÑÂú∞ÊîØÁöÑÂçÅ‰∫åÈïøÁîüÁä∂ÊÄÅ (ÁÇπÂáªÂàáÊç¢)');
    labelCell.style.cursor = 'pointer';

    // Ë∞ÉËØïÔºöÊ£ÄÊü•Âú∞ÂäøÊï∞ÊçÆ
    console.log('üîç BaziTableManager Âú∞ÂäøÊï∞ÊçÆÊ£ÄÊü•:');
    console.log('yearDiShi:', this.baziInfo.yearDiShi);
    console.log('monthDiShi:', this.baziInfo.monthDiShi);
    console.log('dayDiShi:', this.baziInfo.dayDiShi);
    console.log('timeDiShi:', this.baziInfo.timeDiShi);

    // Âπ¥Êü±Âú∞Âäø
    const yearDiShiCell = diShiRow.createEl('td');
    if (this.baziInfo.yearDiShi) {
      const yearDiShiSpan = yearDiShiCell.createSpan({
        text: this.baziInfo.yearDiShi,
        cls: 'dishi-tag-small'
      });
      this.applyDiShiColor(yearDiShiSpan, this.baziInfo.yearDiShi);
    }

    // ÊúàÊü±Âú∞Âäø
    const monthDiShiCell = diShiRow.createEl('td');
    if (this.baziInfo.monthDiShi) {
      const monthDiShiSpan = monthDiShiCell.createSpan({
        text: this.baziInfo.monthDiShi,
        cls: 'dishi-tag-small'
      });
      this.applyDiShiColor(monthDiShiSpan, this.baziInfo.monthDiShi);
    }

    // Êó•Êü±Âú∞Âäø
    const dayDiShiCell = diShiRow.createEl('td');
    if (this.baziInfo.dayDiShi) {
      const dayDiShiSpan = dayDiShiCell.createSpan({
        text: this.baziInfo.dayDiShi,
        cls: 'dishi-tag-small'
      });
      this.applyDiShiColor(dayDiShiSpan, this.baziInfo.dayDiShi);
    }

    // Êó∂Êü±Âú∞Âäø
    const timeDiShiCell = diShiRow.createEl('td');
    if (this.baziInfo.timeDiShi) {
      const timeDiShiSpan = timeDiShiCell.createSpan({
        text: this.baziInfo.timeDiShi,
        cls: 'dishi-tag-small'
      });
      this.applyDiShiColor(timeDiShiSpan, this.baziInfo.timeDiShi);
    }
  }

  /**
   * ÂàõÂª∫Á∫≥Èü≥Ë°åÔºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private createNaYinRow(tbody: HTMLElement) {
    const naYinRow = tbody.createEl('tr', { cls: 'bazi-nayin-row' });
    naYinRow.createEl('td', { text: 'Á∫≥Èü≥', cls: 'bazi-table-label' });

    // Âπ¥Êü±Á∫≥Èü≥
    const yearNaYinCell = naYinRow.createEl('td', { text: this.baziInfo.yearNaYin || '' });
    if (this.baziInfo.yearNaYin) {
      ColorSchemeService.setNaYinColor(yearNaYinCell, this.baziInfo.yearNaYin);
    }

    // ÊúàÊü±Á∫≥Èü≥
    const monthNaYinCell = naYinRow.createEl('td', { text: this.baziInfo.monthNaYin || '' });
    if (this.baziInfo.monthNaYin) {
      ColorSchemeService.setNaYinColor(monthNaYinCell, this.baziInfo.monthNaYin);
    }

    // Êó•Êü±Á∫≥Èü≥
    const dayNaYinCell = naYinRow.createEl('td', { text: this.baziInfo.dayNaYin || '' });
    if (this.baziInfo.dayNaYin) {
      ColorSchemeService.setNaYinColor(dayNaYinCell, this.baziInfo.dayNaYin);
    }

    // Êó∂Êü±Á∫≥Èü≥
    const timeNaYinCell = naYinRow.createEl('td', { text: this.baziInfo.timeNaYin || '' });
    if (this.baziInfo.timeNaYin) {
      ColorSchemeService.setNaYinColor(timeNaYinCell, this.baziInfo.timeNaYin);
    }
  }

  /**
   * ÂàõÂª∫Êó¨Á©∫Ë°åÔºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private createXunKongRow(tbody: HTMLElement) {
    const xunKongRow = tbody.createEl('tr', { cls: 'bazi-xunkong-row' });
    xunKongRow.createEl('td', { text: 'Êó¨Á©∫', cls: 'bazi-table-label' });

    // Âπ¥Êü±Êó¨Á©∫
    const yearXunKongCell = xunKongRow.createEl('td');
    if (this.baziInfo.yearXunKong) {
      ColorSchemeService.createColoredXunKongElement(yearXunKongCell, this.baziInfo.yearXunKong);
    }

    // ÊúàÊü±Êó¨Á©∫
    const monthXunKongCell = xunKongRow.createEl('td');
    if (this.baziInfo.monthXunKong) {
      ColorSchemeService.createColoredXunKongElement(monthXunKongCell, this.baziInfo.monthXunKong);
    }

    // Êó•Êü±Êó¨Á©∫
    const dayXunKongCell = xunKongRow.createEl('td');
    if (this.baziInfo.dayXunKong) {
      ColorSchemeService.createColoredXunKongElement(dayXunKongCell, this.baziInfo.dayXunKong);
    }

    // Êó∂Êü±Êó¨Á©∫
    const timeXunKongCell = xunKongRow.createEl('td');
    if (this.baziInfo.timeXunKong) {
      ColorSchemeService.createColoredXunKongElement(timeXunKongCell, this.baziInfo.timeXunKong);
    }
  }

  /**
   * ÂàõÂª∫ÁîüËÇñË°å
   */
  private createShengXiaoRow(tbody: HTMLElement) {
    const shengXiaoRow = tbody.createEl('tr', { cls: 'bazi-shengxiao-row' });
    shengXiaoRow.createEl('td', { text: 'ÁîüËÇñ', cls: 'bazi-table-label' });

    // Âπ¥Êü±ÁîüËÇñ
    shengXiaoRow.createEl('td', { text: this.baziInfo.yearShengXiao || '' });
    // ÊúàÊü±ÁîüËÇñ
    shengXiaoRow.createEl('td', { text: this.baziInfo.monthShengXiao || '' });
    // Êó•Êü±ÁîüËÇñ
    shengXiaoRow.createEl('td', { text: this.baziInfo.dayShengXiao || '' });
    // Êó∂Êü±ÁîüËÇñ
    shengXiaoRow.createEl('td', { text: this.baziInfo.timeShengXiao || '' });
  }

  /**
   * ÂàõÂª∫Á•ûÁÖûË°å
   */
  private createShenShaRow(tbody: HTMLElement) {
    // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Á•ûÁÖû
    if (this.baziInfo.showShenSha && this.baziInfo.showShenSha.siZhu === false) {
      return;
    }

    // Ëß£ÊûêÁ•ûÁÖûÊï∞ÊçÆ
    const shenShaData = this.parseShenShaData();

    // Â¶ÇÊûúÊ≤°ÊúâÁ•ûÁÖûÊï∞ÊçÆÔºå‰∏çÂàõÂª∫Ë°å
    if (!shenShaData.hasAny) {
      return;
    }

    const shenShaRow = tbody.createEl('tr', { cls: 'bazi-shensha-row' });
    shenShaRow.createEl('td', { text: 'Á•ûÁÖû', cls: 'bazi-table-label' });

    // Âπ¥Êü±Á•ûÁÖû
    const yearShenShaCell = shenShaRow.createEl('td');
    this.createShenShaContent(yearShenShaCell, shenShaData.year);

    // ÊúàÊü±Á•ûÁÖû
    const monthShenShaCell = shenShaRow.createEl('td');
    this.createShenShaContent(monthShenShaCell, shenShaData.month);

    // Êó•Êü±Á•ûÁÖû
    const dayShenShaCell = shenShaRow.createEl('td');
    this.createShenShaContent(dayShenShaCell, shenShaData.day);

    // Êó∂Êü±Á•ûÁÖû
    const timeShenShaCell = shenShaRow.createEl('td');
    this.createShenShaContent(timeShenShaCell, shenShaData.time);
  }

  /**
   * Ëß£ÊûêÁ•ûÁÖûÊï∞ÊçÆÔºåÂÖºÂÆπÊñ∞ÊóßÊ†ºÂºè
   */
  private parseShenShaData() {
    const result = {
      year: [] as string[],
      month: [] as string[],
      day: [] as string[],
      time: [] as string[],
      hasAny: false
    };

    // ‰ºòÂÖà‰ΩøÁî®Êñ∞Ê†ºÂºèÔºàÂàÜÊü±Á•ûÁÖûÔºâ
    if (this.baziInfo.yearShenSha || this.baziInfo.monthShenSha ||
        this.baziInfo.dayShenSha || this.baziInfo.timeShenSha) {
      result.year = this.baziInfo.yearShenSha || [];
      result.month = this.baziInfo.monthShenSha || [];
      result.day = this.baziInfo.dayShenSha || [];
      result.time = this.baziInfo.timeShenSha || [];
    }
    // ÂÖºÂÆπÊóßÊ†ºÂºèÔºàÂ∏¶Êü±‰ΩçÂâçÁºÄÁöÑÁ•ûÁÖûÊï∞ÁªÑÔºâ
    else if (this.baziInfo.shenSha && this.baziInfo.shenSha.length > 0) {
      this.baziInfo.shenSha.forEach(shenSha => {
        if (shenSha.startsWith('Âπ¥Êü±:')) {
          result.year.push(shenSha.substring(3));
        } else if (shenSha.startsWith('ÊúàÊü±:')) {
          result.month.push(shenSha.substring(3));
        } else if (shenSha.startsWith('Êó•Êü±:')) {
          result.day.push(shenSha.substring(3));
        } else if (shenSha.startsWith('Êó∂Êü±:')) {
          result.time.push(shenSha.substring(3));
        }
      });
    }

    result.hasAny = result.year.length > 0 || result.month.length > 0 ||
                    result.day.length > 0 || result.time.length > 0;

    return result;
  }

  /**
   * Ëé∑ÂèñË°®Ê†ºÂºïÁî®
   */
  getBaziTable(): HTMLTableElement | null {
    return this.baziTable;
  }

  /**
   * Â∫îÁî®Â§©Âπ≤‰∫îË°åÈ¢úËâ≤Ôºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private applyStemWuXingColor(element: HTMLElement, stem: string) {
    ColorSchemeService.setGanColor(element, stem);
  }

  /**
   * Â∫îÁî®Âú∞ÊîØ‰∫îË°åÈ¢úËâ≤Ôºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private applyBranchWuXingColor(element: HTMLElement, branch: string) {
    ColorSchemeService.setZhiColor(element, branch);
  }

  /**
   * ÂàõÂª∫Â∏¶È¢úËâ≤ÁöÑËóèÂπ≤
   */
  private createColoredHideGan(element: HTMLElement, hideGan: string) {
    if (!hideGan) return;

    for (const gan of hideGan) {
      const span = element.createSpan({ text: gan });
      this.applyStemWuXingColor(span, gan);
    }
  }

  /**
   * ÂàõÂª∫Á•ûÁÖûÂÜÖÂÆπÔºà‰ΩøÁî®Áªü‰∏ÄÁöÑColorSchemeServiceÔºâ
   */
  private createShenShaContent(element: HTMLElement, shenSha: string[] | undefined) {
    if (!shenSha || shenSha.length === 0) {
      return;
    }

    // Áõ¥Êé•‰ΩøÁî®ColorSchemeServiceÁöÑÁªü‰∏ÄÁ•ûÁÖûÂÖÉÁ¥†ÂàõÂª∫ÊñπÊ≥ï
    ColorSchemeService.createColoredShenShaElement(
      element,
      shenSha,
      (sha) => this.handleShenShaClick(sha),
      'shensha-element'
    );
  }

  /**
   * Â§ÑÁêÜÁ•ûÁÖûÁÇπÂáª‰∫ã‰ª∂
   */
  private handleShenShaClick(shenSha: string) {
    console.log(`üéØ Á•ûÁÖûË¢´ÁÇπÂáª: ${shenSha}`);

    // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂ÔºåËÆ©Áà∂ÁªÑ‰ª∂Â§ÑÁêÜ
    const event = new CustomEvent('shensha-click', {
      detail: { shenSha },
      bubbles: true
    });
    this.container.dispatchEvent(event);
  }



  /**
   * Áõ¥Êé•ËÆæÁΩÆ‰∫îË°åÈ¢úËâ≤Ôºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private setWuXingColorDirectly(element: HTMLElement, wuXing: string) {
    const color = ColorSchemeService.getWuXingColor(wuXing);
    if (color && color !== 'var(--text-normal)') {
      element.style.setProperty('color', color, 'important');
      element.style.setProperty('font-weight', 'bold', 'important');
      element.style.setProperty('text-shadow', '0 1px 2px rgba(0, 0, 0, 0.2)', 'important');
    }
  }

  /**
   * Â∫îÁî®ÂçÅÁ•ûÈ¢úËâ≤Ôºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private applyShiShenColor(element: HTMLElement, shiShen: string) {
    const color = ColorSchemeService.getShiShenColor(shiShen);
    if (color && color !== 'var(--text-normal)') {
      // ‰ΩøÁî®!importantÁ°Æ‰øùÊ†∑Âºè‰ºòÂÖàÁ∫ß
      element.style.setProperty('color', color, 'important');
      element.style.setProperty('font-weight', 'bold', 'important');
      element.style.setProperty('text-shadow', '0 1px 2px rgba(0, 0, 0, 0.2)', 'important');

      // Ë∞ÉËØïÔºöÁ°ÆËÆ§Ê†∑ÂºèÂ∫îÁî®
      console.log(`üé® Â∫îÁî®ÂçÅÁ•ûÈ¢úËâ≤: ${shiShen} -> ${color}`);
    }
  }

  /**
   * Â∫îÁî®Âú∞ÂäøÈ¢úËâ≤Ôºà‰ΩøÁî®Áªü‰∏ÄÈ¢úËâ≤ÊñπÊ°àÔºâ
   */
  private applyDiShiColor(element: HTMLElement, diShi: string) {
    const color = ColorSchemeService.getDiShiColor(diShi);
    if (color && color !== 'var(--text-normal)') {
      // ‰ΩøÁî®!importantÁ°Æ‰øùÊ†∑Âºè‰ºòÂÖàÁ∫ß
      element.style.setProperty('color', color, 'important');
      element.style.setProperty('font-weight', 'bold', 'important');
      element.style.setProperty('text-shadow', '0 1px 2px rgba(0, 0, 0, 0.2)', 'important');

      // Ë∞ÉËØïÔºöÁ°ÆËÆ§Ê†∑ÂºèÂ∫îÁî®
      console.log(`üé® Â∫îÁî®Âú∞ÂäøÈ¢úËâ≤: ${diShi} -> ${color}`);
    }
  }

}
