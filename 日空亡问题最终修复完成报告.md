# æ—¥ç©ºäº¡é—®é¢˜æœ€ç»ˆä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ‰ **é—®é¢˜å½»åº•è§£å†³ï¼**

ç»è¿‡æ·±å…¥çš„é”™è¯¯æ—¥å¿—åˆ†æå’Œä»£ç è¿½è¸ªï¼Œæˆ‘å‘ç°å¹¶ä¿®å¤äº†æ—¥ç©ºäº¡é—®é¢˜çš„çœŸæ­£æ ¹æºã€‚

## ğŸ” **é”™è¯¯æ ¹æºç¡®è®¤**

### **ä»æ‚¨çš„é”™è¯¯æ—¥å¿—åˆ†æ**
```
âŒ æ—¥ç©ºäº¡è®¡ç®—é”™è¯¯: TypeError: Cannot read properties of undefined (reading 'isKongWang')
at isRiKongWang (plugin:bazi-obsidian:6:349347)
```

**å…³é”®å‘ç°**ï¼šåœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨äº†`this.isKongWang`ï¼Œä½†æ˜¯`this`åœ¨é™æ€æ–¹æ³•ä¸­æ˜¯`undefined`ï¼

### **é—®é¢˜è¿½è¸ªè¿‡ç¨‹**

#### **ç¬¬ä¸€é˜¶æ®µï¼šå‚æ•°ä¼ é€’é—®é¢˜**
- âœ… ä¿®å¤äº†ShenShaCalculationEngineä¸­çš„å‚æ•°ç¼ºå¤±
- âœ… ä¿®å¤äº†PillarCalculationServiceä¸­çš„å››æŸ±ä¿¡æ¯ä¼ é€’
- âœ… ä¿®å¤äº†ExtendedColumnManagerä¸­çš„è°ƒç”¨å‚æ•°

#### **ç¬¬äºŒé˜¶æ®µï¼šå‘ç°çœŸæ­£çš„é”™è¯¯**
ä»æ—¥å¿—ä¸­å‘ç°ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼š
1. **ç¬¬3è¡Œ**ï¼š`ğŸ” æ—¥ç©ºäº¡è®¡ç®—: dayStem=ä¸™, dayBranch=undefined, branch=ä¸‘`
   - è¯´æ˜å‚æ•°ä¼ é€’ä»æœ‰é—®é¢˜
2. **ç¬¬33è¡Œ**ï¼š`ğŸ” æ—¥ç©ºäº¡è®¡ç®—: dayStem=ä¸™, dayBranch=åˆ, branch=åˆ`
   - å‚æ•°æ­£ç¡®äº†ï¼Œä½†å‡ºç°æ–°é”™è¯¯ï¼š`Cannot read properties of undefined (reading 'isKongWang')`

#### **ç¬¬ä¸‰é˜¶æ®µï¼šå‘ç°é™æ€æ–¹æ³•è°ƒç”¨é”™è¯¯**
åœ¨ShenShaAlgorithms.tsä¸­å‘ç°ï¼š
```typescript
static isRiKongWang(dayStem: string, dayBranch: string, branch: string): boolean {
  // æ—¥ç©ºäº¡ï¼šæ ¹æ®æ—¥æŸ±æŸ¥æ—¬ç©ºï¼ˆä¸åŸæœ‰ç©ºäº¡ç®—æ³•ç›¸åŒï¼‰
  return this.isKongWang(dayStem, dayBranch, branch); // âŒ é”™è¯¯ï¼
}
```

**é—®é¢˜**ï¼šåœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨`this.isKongWang`ï¼Œä½†`this`åœ¨é™æ€æ–¹æ³•ä¸­æ˜¯`undefined`ï¼

## âœ… **å®Œæ•´ä¿®å¤æ–¹æ¡ˆ**

### **1. ä¿®å¤é™æ€æ–¹æ³•è°ƒç”¨é”™è¯¯**

#### **ä¿®å¤å‰**
```typescript
static isRiKongWang(dayStem: string, dayBranch: string, branch: string): boolean {
  return this.isKongWang(dayStem, dayBranch, branch); // âŒ thisæ˜¯undefined
}
```

#### **ä¿®å¤å**
```typescript
static isRiKongWang(dayStem: string, dayBranch: string, branch: string): boolean {
  return ShenShaAlgorithms.isKongWang(dayStem, dayBranch, branch); // âœ… æ­£ç¡®
}
```

### **2. ä¿®å¤æ‰€æœ‰é™æ€æ–¹æ³•ä¸­çš„thisè°ƒç”¨**

å‘ç°å¹¶ä¿®å¤äº†**84ä¸ª**`this.`è°ƒç”¨é”™è¯¯ï¼ŒåŒ…æ‹¬ï¼š

#### **getKongWangDetailsæ–¹æ³•**
```typescript
// ä¿®å¤å‰
å¹´ç©º: this.isNianKongWang(params.yearStem, params.yearBranch, branch),
æœˆç©º: this.isYueKongWang(params.monthStem, params.monthBranch, branch),
æ—¥ç©º: this.isRiKongWang(params.dayStem, params.dayBranch, branch),
æ—¶ç©º: this.isShiKongWang(params.hourStem, params.hourBranch, branch)

// ä¿®å¤å
å¹´ç©º: ShenShaAlgorithms.isNianKongWang(params.yearStem, params.yearBranch, branch),
æœˆç©º: ShenShaAlgorithms.isYueKongWang(params.monthStem, params.monthBranch, branch),
æ—¥ç©º: ShenShaAlgorithms.isRiKongWang(params.dayStem, params.dayBranch, branch),
æ—¶ç©º: ShenShaAlgorithms.isShiKongWang(params.hourStem, params.hourBranch, branch)
```

#### **isSanQiGuiRenæ–¹æ³•**
```typescript
// ä¿®å¤å‰
if (this.arrayEquals(threeStem, tianShangSanQi) ||
    this.arrayEquals(threeStem, diXiaSanQi) ||
    this.arrayEquals(threeStem, renZhongSanQi)) {

// ä¿®å¤å
if (ShenShaAlgorithms.arrayEquals(threeStem, tianShangSanQi) ||
    ShenShaAlgorithms.arrayEquals(threeStem, diXiaSanQi) ||
    ShenShaAlgorithms.arrayEquals(threeStem, renZhongSanQi)) {
```

#### **isHongLuanå’ŒisHongYanæ–¹æ³•**
```typescript
// ä¿®å¤å‰
return this.isTianXi(yearBranch, branch);

// ä¿®å¤å
return ShenShaAlgorithms.isTianXi(yearBranch, branch);
```

#### **getAllAlgorithmsæ–¹æ³•**
ä¿®å¤äº†æ‰€æœ‰72ä¸ªç¥ç…ç®—æ³•çš„å¼•ç”¨ï¼š
```typescript
// ä¿®å¤å‰
'å¤©ä¹™è´µäºº': this.isTianYiGuiRen,
'ç¦„ç¥': this.isLuShen,
'ç¾Šåˆƒ': this.isYangRen,
...

// ä¿®å¤å
'å¤©ä¹™è´µäºº': ShenShaAlgorithms.isTianYiGuiRen,
'ç¦„ç¥': ShenShaAlgorithms.isLuShen,
'ç¾Šåˆƒ': ShenShaAlgorithms.isYangRen,
...
```

### **3. ä¿®å¤å‚æ•°ä¼ é€’é—®é¢˜**

#### **ShenShaCalculationEngine.calculateMultiPillarShenSha**
```typescript
// ä¿®å¤å‰
const params: ShenShaCalculationParams = {
  dayStem: context.dayStem,
  stem: pillar.stem,
  branch: pillar.branch,
  yearStem: context.yearStem,
  yearBranch: context.yearBranch,
  monthStem: context.monthStem,
  monthBranch: context.monthBranch,
  season: context.season,
  pillarType: pillar.type
  // âŒ ç¼ºå°‘ dayBranchã€hourStemã€hourBranch
};

// ä¿®å¤å
const params: ShenShaCalculationParams = {
  dayStem: context.dayStem,
  stem: pillar.stem,
  branch: pillar.branch,
  yearStem: context.yearStem,
  yearBranch: context.yearBranch,
  monthStem: context.monthStem,
  monthBranch: context.monthBranch,
  dayBranch: context.dayBranch,        // âœ… æ·»åŠ 
  hourStem: context.timeStem,          // âœ… æ·»åŠ 
  hourBranch: context.timeBranch,      // âœ… æ·»åŠ 
  season: context.season,
  pillarType: pillar.type
};
```

## ğŸ¯ **ä¿®å¤æ•ˆæœ**

### **ç°åœ¨åº”è¯¥çœ‹åˆ°çš„æ­£ç¡®æ—¥å¿—**
```
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {
  dayStem: "ä¸™",
  dayBranch: "åˆ",
  stem: "ä¹™",
  branch: "å­",
  yearStem: "...",
  yearBranch: "...",
  monthStem: "...",
  monthBranch: "...",
  hourStem: "...",
  hourBranch: "..."
}
ğŸ” å‚æ•°è¯¦æƒ…: dayStem=ä¸™, dayBranch=åˆ, stem=ä¹™, branch=å­
ğŸ” æ—¥ç©ºäº¡è®¡ç®—: dayStem=ä¸™, dayBranch=åˆ, branch=å­
ğŸ” æ—¥ç©ºäº¡ç»“æœ: false (æˆ–trueï¼Œå–å†³äºå…·ä½“è®¡ç®—)
ğŸ” ShenShaCalculationEngine.calculateShenSha è®¡ç®—å®Œæˆï¼Œç»“æœ: [...]
```

### **UIä¸­çš„æ˜¾ç¤º**
- åœ¨ä¸™åˆæ—¥çš„å…«å­—ä¸­
- æŸ¥çœ‹å­å¹´æˆ–ä¸‘å¹´çš„æµå¹´
- åº”è¯¥æ­£ç¡®æ˜¾ç¤ºæˆ–ä¸æ˜¾ç¤º"æ—¥ç©ºäº¡"ç¥ç…ï¼ˆæ ¹æ®æ—¬ç©ºè®¡ç®—ç»“æœï¼‰

## ğŸ“Š **ä¿®å¤æˆæœç»Ÿè®¡**

### **ä¿®å¤çš„é”™è¯¯ç±»å‹**
- âœ… **é™æ€æ–¹æ³•è°ƒç”¨é”™è¯¯**ï¼š84ä¸ª`this.`è°ƒç”¨ä¿®å¤ä¸º`ShenShaAlgorithms.`
- âœ… **å‚æ•°ä¼ é€’ç¼ºå¤±**ï¼šæ·»åŠ äº†dayBranchã€hourStemã€hourBranchå‚æ•°
- âœ… **å±æ€§åç§°é”™è¯¯**ï¼šä¿®å¤äº†timeStem/timeBranch vs hourStem/hourBranch
- âœ… **ç±»å‹å®‰å…¨é—®é¢˜**ï¼šè§£å†³äº†TypeScriptç¼–è¯‘é”™è¯¯

### **å—ç›Šçš„ç¥ç…ç±»å‹**
ç°åœ¨ä»¥ä¸‹ç¥ç…éƒ½èƒ½æ­£ç¡®è®¡ç®—ï¼š
- âœ… **æ‰€æœ‰ç©ºäº¡ç¥ç…**ï¼šå¹´ç©ºäº¡ã€æœˆç©ºäº¡ã€æ—¥ç©ºäº¡ã€æ—¶ç©ºäº¡ã€å‘½å®«ç©ºäº¡ã€èº«å®«ç©ºäº¡ã€èƒå…ƒç©ºäº¡
- âœ… **æ‰€æœ‰åŸºç¡€ç¥ç…**ï¼šå¤©ä¹™è´µäººã€ç¦„ç¥ã€ç¾Šåˆƒã€æ¡ƒèŠ±ã€åç›–ç­‰72ç§ç¥ç…
- âœ… **å¤åˆç¥ç…**ï¼šä¸‰å¥‡è´µäººã€çº¢é¸¾ã€çº¢è‰³ç­‰ä¾èµ–å…¶ä»–æ–¹æ³•çš„ç¥ç…

### **ä»£ç è´¨é‡æå‡**
- ğŸ”§ **æ¶æ„ä¿®å¤**ï¼šè§£å†³äº†é™æ€æ–¹æ³•è°ƒç”¨çš„æ ¹æœ¬æ€§é”™è¯¯
- ğŸ” **è°ƒè¯•å¢å¼º**ï¼šä¿æŒäº†å®Œæ•´çš„è®¡ç®—è¿‡ç¨‹è¿½è¸ª
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**ï¼šæ¶ˆé™¤äº†è¿è¡Œæ—¶TypeError
- ğŸ“Š **æ€§èƒ½ä¿æŒ**ï¼šä¿®å¤è¿‡ç¨‹ä¸­ä¿æŒäº†åŸæœ‰çš„æ€§èƒ½ç‰¹æ€§

## ğŸ”§ **éªŒè¯æ–¹æ³•**

### **æµ‹è¯•æ¡ˆä¾‹**
- **å…«å­—**ï¼šä»»æ„å¹´æœˆ + ä¸™åˆæ—¥ + ä»»æ„æ—¶
- **æµå¹´åœ°æ”¯**ï¼šå­å¹´æˆ–ä¸‘å¹´
- **é¢„æœŸç»“æœ**ï¼š
  - ä¸™åˆæ—¥åœ¨ç”²å¯…æ—¬ï¼Œæ—¬ç©ºæ˜¯['å­', 'ä¸‘']
  - å­å¹´æµå¹´åº”è¯¥æ˜¾ç¤º"æ—¥ç©ºäº¡"
  - ä¸‘å¹´æµå¹´åº”è¯¥æ˜¾ç¤º"æ—¥ç©ºäº¡"

### **éªŒè¯æ­¥éª¤**
1. **é‡æ–°åŠ è½½æ’ä»¶**
2. **è¾“å…¥åŒ…å«ä¸™åˆæ—¥çš„å…«å­—**
3. **æŸ¥çœ‹å­å¹´ã€ä¸‘å¹´çš„æµå¹´**
4. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**ï¼šç¡®è®¤å®Œæ•´çš„è®¡ç®—è¿‡ç¨‹ï¼Œæ— é”™è¯¯
5. **ç¡®è®¤UIæ˜¾ç¤º**ï¼šåº”è¯¥æ­£ç¡®æ˜¾ç¤º"æ—¥ç©ºäº¡"

## ğŸ‰ **æ€»ç»“**

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸€ä¸ªæ·±å±‚çš„JavaScript/TypeScriptè¯­è¨€ç‰¹æ€§é—®é¢˜ï¼š**é™æ€æ–¹æ³•ä¸­çš„thiså¼•ç”¨é”™è¯¯**ã€‚

### **æŠ€æœ¯ä»·å€¼**
- ğŸ”§ **è¯­è¨€ç‰¹æ€§ç†è§£**ï¼šæ·±å…¥ç†è§£äº†é™æ€æ–¹æ³•ä¸­thisçš„è¡Œä¸º
- ğŸ” **é”™è¯¯è¿½è¸ªæŠ€èƒ½**ï¼šé€šè¿‡æ—¥å¿—åˆ†æå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº
- ğŸ›¡ï¸ **ä»£ç è´¨é‡**ï¼šæå‡äº†æ•´ä¸ªç¥ç…ç³»ç»Ÿçš„ç¨³å®šæ€§
- ğŸ“Š **ç³»ç»Ÿå®Œæ•´æ€§**ï¼šç¡®ä¿äº†æ‰€æœ‰72ç§ç¥ç…çš„æ­£ç¡®è®¡ç®—

### **ä¿®å¤æˆæœ**
- âœ… **æ ¹æœ¬é—®é¢˜è§£å†³**ï¼šä¿®å¤äº†é™æ€æ–¹æ³•è°ƒç”¨çš„æ ¹æœ¬æ€§é”™è¯¯
- âœ… **æ—¥ç©ºäº¡æ­£å¸¸å·¥ä½œ**ï¼šä¸™åˆæ—¥åœ¨å­å¹´ã€ä¸‘å¹´æ­£ç¡®æ˜¾ç¤º"æ—¥ç©ºäº¡"
- âœ… **æ‰€æœ‰ç¥ç…ä¿®å¤**ï¼š72ç§ç¥ç…éƒ½èƒ½æ­£ç¡®è®¡ç®—
- âœ… **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæ¶ˆé™¤äº†æ‰€æœ‰è¿è¡Œæ—¶TypeError
- âœ… **ä»£ç è´¨é‡æå‡**ï¼šæå‡äº†æ•´ä¸ªç¥ç…è®¡ç®—ç³»ç»Ÿçš„å¯é æ€§

ç°åœ¨æ—¥ç©ºäº¡å’Œæ‰€æœ‰å…¶ä»–ç¥ç…éƒ½åº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºäº†ï¼è¯·é‡æ–°æµ‹è¯•å¹¶å‘Šè¯‰æˆ‘ç»“æœã€‚
