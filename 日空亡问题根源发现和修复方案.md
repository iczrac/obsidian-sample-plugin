# æ—¥ç©ºäº¡é—®é¢˜æ ¹æºå‘ç°å’Œä¿®å¤æ–¹æ¡ˆ

## ğŸš¨ **é—®é¢˜æ ¹æºç¡®è®¤**

é€šè¿‡åˆ†ææ‚¨æä¾›çš„æ—¥å¿—ï¼Œæˆ‘å‘ç°äº†æ—¥ç©ºäº¡é—®é¢˜çš„çœŸæ­£æ ¹æºï¼š

### **ä»æ—¥å¿—ä¸­å‘ç°çš„å…³é”®é—®é¢˜**
```
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {dayStem: 'ä¸™', stem: 'ä¹™', branch: 'ä¸‘'}
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {dayStem: 'ä¸™', stem: 'å£¬', branch: 'åˆ'}
```

**å…³é”®å‘ç°**ï¼š
1. âŒ **ç¼ºå°‘dayBranchå‚æ•°**ï¼šå‚æ•°ä¸­æ²¡æœ‰`dayBranch`ï¼
2. âŒ **ç¼ºå°‘å…¶ä»–å››æŸ±å‚æ•°**ï¼šæ²¡æœ‰`yearStem`, `yearBranch`, `monthStem`, `monthBranch`ç­‰
3. âŒ **æ—¥ç©ºäº¡æ— æ³•è®¡ç®—**ï¼šæ²¡æœ‰`dayBranch`ï¼Œæ—¥ç©ºäº¡ç®—æ³•æ— æ³•æ‰§è¡Œ

### **æ—¥ç©ºäº¡ç®—æ³•éœ€è¦çš„å‚æ•°**
```typescript
case 'æ—¥ç©ºäº¡': {
  // éœ€è¦ï¼šdayStem, dayBranch, branch
  return algorithm(dayStem, dayBranch, branch);
}
```

**å®é™…ä¼ é€’çš„å‚æ•°**ï¼š
```javascript
{dayStem: 'ä¸™', stem: 'ä¹™', branch: 'ä¸‘'}  // ç¼ºå°‘dayBranchï¼
```

## ğŸ” **é—®é¢˜è¿½è¸ª**

### **å‚æ•°ä¼ é€’é“¾æ¡åˆ†æ**

#### **1. ShenShaTimeService.calculatePillarShenSha** âœ… **æ­£ç¡®**
```typescript
const calculationParams: ShenShaCalculationParams = {
  dayStem,
  stem,
  branch,
  pillarType,
  yearStem,
  yearBranch,
  monthStem,
  monthBranch,
  dayBranch,    // âœ… æ­£ç¡®ä¼ é€’
  hourStem,
  hourBranch
};
```

#### **2. PillarCalculationServiceè°ƒç”¨** âŒ **é—®é¢˜æ‰€åœ¨**
```typescript
// ç¬¬86è¡Œ - å¤§è¿ç¥ç…è®¡ç®—
shenSha: daYun.shenSha || ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi),

// ç¬¬124è¡Œ - æµå¹´ç¥ç…è®¡ç®—  
shenSha: liuNian.shenSha || ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi),
```

**é—®é¢˜**ï¼šè¿™äº›è°ƒç”¨éƒ½æ²¡æœ‰ä¼ é€’`fourPillarInfo`å‚æ•°ï¼

#### **3. ShenShaTimeService.calculateDaYunShenSha** âŒ **å‚æ•°ç¼ºå¤±**
```typescript
static calculateDaYunShenSha(
  dayStem: string,
  ganZhi: string,
  fourPillarInfo?: {  // â† è¿™ä¸ªå‚æ•°æ²¡æœ‰è¢«ä¼ é€’ï¼
    yearStem: string, yearBranch: string,
    monthStem: string, monthBranch: string,
    dayBranch: string,
    hourStem: string, hourBranch: string
  }
): string[] {
  // ...
  return this.calculatePillarShenSha({
    dayStem,
    stem,
    branch,
    pillarType: 'å¤§è¿',
    ...fourPillarInfo  // â† fourPillarInfoæ˜¯undefinedï¼Œæ‰€ä»¥å±•å¼€åä»€ä¹ˆéƒ½æ²¡æœ‰
  });
}
```

## âœ… **ä¿®å¤æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šå¢å¼ºè°ƒè¯•ä¿¡æ¯ï¼ˆå·²å®æ–½ï¼‰**
```typescript
console.log(`ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°:`, params);
console.log(`ğŸ” å‚æ•°è¯¦æƒ…: dayStem=${params.dayStem}, dayBranch=${params.dayBranch}, stem=${params.stem}, branch=${params.branch}`);
```

### **æ–¹æ¡ˆ2ï¼šä¿®å¤PillarCalculationServiceï¼ˆéœ€è¦å®æ–½ï¼‰**

#### **ä¿®å¤å¤§è¿ç¥ç…è®¡ç®—**
```typescript
// ä¿®å¤å‰
shenSha: daYun.shenSha || ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi),

// ä¿®å¤å
shenSha: daYun.shenSha || ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi, {
  yearStem: fourPillarInfo.yearStem,
  yearBranch: fourPillarInfo.yearBranch,
  monthStem: fourPillarInfo.monthStem,
  monthBranch: fourPillarInfo.monthBranch,
  dayBranch: fourPillarInfo.dayBranch,
  hourStem: fourPillarInfo.hourStem,
  hourBranch: fourPillarInfo.hourBranch
}),
```

#### **ä¿®å¤æµå¹´ç¥ç…è®¡ç®—**
```typescript
// ä¿®å¤å‰
shenSha: liuNian.shenSha || ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi),

// ä¿®å¤å
shenSha: liuNian.shenSha || ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi, {
  yearStem: fourPillarInfo.yearStem,
  yearBranch: fourPillarInfo.yearBranch,
  monthStem: fourPillarInfo.monthStem,
  monthBranch: fourPillarInfo.monthBranch,
  dayBranch: fourPillarInfo.dayBranch,
  hourStem: fourPillarInfo.hourStem,
  hourBranch: fourPillarInfo.hourBranch
}),
```

### **æ–¹æ¡ˆ3ï¼šä¿®æ”¹æ–¹æ³•ç­¾åï¼ˆéœ€è¦å®æ–½ï¼‰**

#### **ä¿®æ”¹calculateDaYunPillaræ–¹æ³•**
```typescript
// ä¿®æ”¹å‰
static calculateDaYunPillar(daYun: DaYunInfo, dayStem: string): ExtendedPillarInfo | null

// ä¿®æ”¹å
static calculateDaYunPillar(
  daYun: DaYunInfo, 
  dayStem: string,
  fourPillarInfo?: {
    yearStem: string, yearBranch: string,
    monthStem: string, monthBranch: string,
    dayBranch: string,
    hourStem: string, hourBranch: string
  }
): ExtendedPillarInfo | null
```

#### **ä¿®æ”¹calculateLiuNianPillaræ–¹æ³•**
```typescript
// ä¿®æ”¹å‰
static calculateLiuNianPillar(liuNian: any, dayStem: string): ExtendedPillarInfo | null

// ä¿®æ”¹å
static calculateLiuNianPillar(
  liuNian: any, 
  dayStem: string,
  fourPillarInfo?: {
    yearStem: string, yearBranch: string,
    monthStem: string, monthBranch: string,
    dayBranch: string,
    hourStem: string, hourBranch: string
  }
): ExtendedPillarInfo | null
```

## ğŸ¯ **éªŒè¯æ–¹æ³•**

### **ç°åœ¨åº”è¯¥çœ‹åˆ°çš„è°ƒè¯•æ—¥å¿—**
ä½¿ç”¨å¢å¼ºçš„è°ƒè¯•ç‰ˆæœ¬ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {...}
ğŸ” å‚æ•°è¯¦æƒ…: dayStem=ä¸™, dayBranch=undefined, stem=ä¹™, branch=ä¸‘
```

è¿™å°†ç¡®è®¤`dayBranch`ç¡®å®æ˜¯`undefined`ã€‚

### **ä¿®å¤ååº”è¯¥çœ‹åˆ°çš„æ—¥å¿—**
```
ğŸ” ShenShaCalculationEngine.calculateShenSha å¼€å§‹è®¡ç®—ï¼Œå‚æ•°: {...}
ğŸ” å‚æ•°è¯¦æƒ…: dayStem=ä¸™, dayBranch=åˆ, stem=ä¹™, branch=ä¸‘
ğŸ” æ—¥ç©ºäº¡è®¡ç®—: dayStem=ä¸™, dayBranch=åˆ, branch=ä¸‘
ğŸ” æ—¥ç©ºäº¡ç»“æœ: false
ğŸ” ShenShaCalculationEngine.calculateShenSha è®¡ç®—å®Œæˆï¼Œç»“æœ: [...]
```

## ğŸ“Š **å½±å“èŒƒå›´**

### **å—å½±å“çš„ç¥ç…ç±»å‹**
ç”±äºç¼ºå°‘å››æŸ±å‚æ•°ï¼Œä»¥ä¸‹ç¥ç…éƒ½æ— æ³•æ­£ç¡®è®¡ç®—ï¼š
- âŒ **æ—¥ç©ºäº¡**ï¼šéœ€è¦dayBranch
- âŒ **å¹´ç©ºäº¡**ï¼šéœ€è¦yearStem, yearBranch
- âŒ **æœˆç©ºäº¡**ï¼šéœ€è¦monthStem, monthBranch
- âŒ **æ—¶ç©ºäº¡**ï¼šéœ€è¦hourStem, hourBranch
- âŒ **å‘½å®«ç©ºäº¡**ï¼šéœ€è¦å®«ä½ä¿¡æ¯
- âŒ **èº«å®«ç©ºäº¡**ï¼šéœ€è¦å®«ä½ä¿¡æ¯
- âŒ **èƒå…ƒç©ºäº¡**ï¼šéœ€è¦å®«ä½ä¿¡æ¯

### **æ­£å¸¸å·¥ä½œçš„ç¥ç…**
åªæœ‰ä¸éœ€è¦å››æŸ±ä¿¡æ¯çš„ç¥ç…èƒ½æ­£å¸¸å·¥ä½œï¼š
- âœ… **æ¡ƒèŠ±**ï¼šåªéœ€è¦yearBranchï¼ˆä½†yearBranchä¹Ÿç¼ºå¤±ï¼‰
- âœ… **å¤ªæè´µäºº**ï¼šåªéœ€è¦dayStemå’Œbranch
- âœ… **é‡‘èˆ†**ï¼šåªéœ€è¦dayStemå’Œbranch

## ğŸš€ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

1. **é‡æ–°æµ‹è¯•**ï¼šä½¿ç”¨å¢å¼ºçš„è°ƒè¯•ç‰ˆæœ¬ï¼Œç¡®è®¤dayBranchç¡®å®æ˜¯undefined
2. **å®æ–½ä¿®å¤**ï¼šä¿®æ”¹PillarCalculationServiceä¸­çš„æ–¹æ³•è°ƒç”¨
3. **ä¼ é€’å››æŸ±ä¿¡æ¯**ï¼šç¡®ä¿æ‰€æœ‰è°ƒç”¨éƒ½ä¼ é€’å®Œæ•´çš„å››æŸ±ä¿¡æ¯
4. **éªŒè¯ç»“æœ**ï¼šç¡®è®¤æ—¥ç©ºäº¡å’Œå…¶ä»–ç©ºäº¡ç¥ç…æ­£ç¡®æ˜¾ç¤º

ç°åœ¨æ‚¨å¯ä»¥é‡æ–°æµ‹è¯•ï¼Œåº”è¯¥èƒ½åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ›´è¯¦ç»†çš„å‚æ•°ä¿¡æ¯ï¼Œç¡®è®¤é—®é¢˜çš„æ ¹æºã€‚
