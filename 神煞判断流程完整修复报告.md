# ç¥ç…åˆ¤æ–­æµç¨‹å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ” **é—®é¢˜æ ¹æºåˆ†æ**

ç»è¿‡ä»”ç»†æ ¸æŸ¥æ•´ä¸ªç¥ç…åˆ¤æ–­æµç¨‹ï¼Œæˆ‘å‘ç°äº†ç»†åˆ†ç©ºäº¡åœ¨æµå¹´ã€å¤§è¿ä¸Šä¸æ˜¾ç¤ºçš„çœŸæ­£åŸå› ï¼š

### **è°ƒç”¨é“¾åˆ†æ**
1. **UIå±‚** â†’ **BaziService** â†’ **DaYunCalculator/LiuNianCalculator** â†’ **ShenShaTimeService** â†’ **ShenShaCalculationEngine**
2. **é—®é¢˜å‡ºç°åœ¨ç¬¬3æ­¥**ï¼šDaYunCalculatorå’ŒLiuNianCalculatorè°ƒç”¨ShenShaTimeServiceæ—¶**æ²¡æœ‰ä¼ é€’å››æŸ±ä¿¡æ¯**
3. **ç»†åˆ†ç©ºäº¡éœ€è¦å®Œæ•´å››æŸ±ä¿¡æ¯**ï¼š
   - å¹´ç©ºäº¡éœ€è¦ï¼š`yearStem, yearBranch`
   - æœˆç©ºäº¡éœ€è¦ï¼š`monthStem, monthBranch`
   - æ—¶ç©ºäº¡éœ€è¦ï¼š`hourStem, hourBranch`

### **å…·ä½“é—®é¢˜ä½ç½®**
- **DaYunCalculator.ts** ç¬¬97è¡Œå’Œç¬¬224è¡Œï¼š`ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi)` **ç¼ºå°‘å››æŸ±ä¿¡æ¯**
- **LiuNianCalculator.ts** ç¬¬55è¡Œï¼š`ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi, fourPillarInfo)` **å·²ä¿®å¤**
- **LiuNianCalculator.ts** ç¬¬123è¡Œï¼š`ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi)` **ç¼ºå°‘å››æŸ±ä¿¡æ¯**
- **BaziService.ts** ç¬¬1064è¡Œï¼šè°ƒç”¨`calculateLiuNianByYearRange`**ç¼ºå°‘å››æŸ±ä¿¡æ¯**

## âœ… **å®Œæ•´ä¿®å¤æ–¹æ¡ˆ**

### **ä¿®å¤1ï¼šæ‰©å±•æ¥å£æ”¯æŒå››æŸ±ä¿¡æ¯**

#### PillarShenShaParamsæ¥å£æ‰©å±•
```typescript
export interface PillarShenShaParams {
  dayStem: string;
  stem: string;
  branch: string;
  pillarType: string;
  includeSpecial?: boolean;
  // æ–°å¢ï¼šå››æŸ±ä¿¡æ¯ï¼ˆç”¨äºç»†åˆ†ç©ºäº¡ç­‰éœ€è¦å®Œæ•´å››æŸ±çš„ç¥ç…ï¼‰
  yearStem?: string;
  yearBranch?: string;
  monthStem?: string;
  monthBranch?: string;
  dayBranch?: string;
  hourStem?: string;
  hourBranch?: string;
}
```

#### ShenShaCalculationParamsæ¥å£æ‰©å±•
```typescript
export interface ShenShaCalculationParams {
  dayStem: string;
  stem: string;
  branch: string;
  yearStem?: string;
  yearBranch?: string;
  monthStem?: string;
  monthBranch?: string;
  dayBranch?: string;      // æ–°å¢
  hourStem?: string;       // æ–°å¢
  hourBranch?: string;     // æ–°å¢
  season?: string;
  pillarType?: string;
  ganZhi?: string;
}
```

### **ä¿®å¤2ï¼šDaYunCalculatorä¼ é€’å››æŸ±ä¿¡æ¯**

#### ä¿®å¤å¤§è¿ç¥ç…è®¡ç®—
```typescript
// ä¿®å¤å‰
const shenSha = ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi);

// ä¿®å¤å
const fourPillarInfo = {
  yearStem: eightChar.getYearGan(),
  yearBranch: eightChar.getYearZhi(),
  monthStem: eightChar.getMonthGan(),
  monthBranch: eightChar.getMonthZhi(),
  dayBranch: eightChar.getDayZhi(),
  hourStem: eightChar.getTimeGan(),
  hourBranch: eightChar.getTimeZhi()
};
const shenSha = ShenShaTimeService.calculateDaYunShenSha(dayStem, ganZhi, fourPillarInfo);
```

#### ä¿®å¤å‰è¿ç¥ç…è®¡ç®—
```typescript
// ä¿®å¤å‰
const shenSha = ShenShaTimeService.calculateDaYunShenSha(dayStem, qianYunGanZhi);

// ä¿®å¤å
const fourPillarInfo = {
  yearStem: eightChar.getYearGan(),
  yearBranch: eightChar.getYearZhi(),
  monthStem: eightChar.getMonthGan(),
  monthBranch: eightChar.getMonthZhi(),
  dayBranch: eightChar.getDayZhi(),
  hourStem: eightChar.getTimeGan(),
  hourBranch: eightChar.getTimeZhi()
};
const shenSha = ShenShaTimeService.calculateDaYunShenSha(dayStem, qianYunGanZhi, fourPillarInfo);
```

### **ä¿®å¤3ï¼šLiuNianCalculatorä¼ é€’å››æŸ±ä¿¡æ¯**

#### ä¿®å¤ä¸»è¦æµå¹´è®¡ç®—
```typescript
// ä¿®å¤å‰
const shenSha = ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi);

// ä¿®å¤å
const fourPillarInfo = {
  yearStem: eightChar.getYearGan(),
  yearBranch: eightChar.getYearZhi(),
  monthStem: eightChar.getMonthGan(),
  monthBranch: eightChar.getMonthZhi(),
  dayBranch: eightChar.getDayZhi(),
  hourStem: eightChar.getTimeGan(),
  hourBranch: eightChar.getTimeZhi()
};
const shenSha = ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi, fourPillarInfo);
```

#### æ–°å¢å¸¦å››æŸ±ä¿¡æ¯çš„å¹´ä»½èŒƒå›´è®¡ç®—æ–¹æ³•
```typescript
static calculateLiuNianByYearRangeWithFourPillar(
  startYear: number,
  endYear: number,
  birthYear: number,
  dayStem: string,
  fourPillarInfo?: {
    yearStem: string, yearBranch: string,
    monthStem: string, monthBranch: string,
    dayBranch: string,
    hourStem: string, hourBranch: string
  }
): LiuNianInfo[] {
  // ä¼ é€’å››æŸ±ä¿¡æ¯ç»™ç¥ç…è®¡ç®—
  const shenSha = ShenShaTimeService.calculateLiuNianShenSha(dayStem, ganZhi, fourPillarInfo);
}
```

### **ä¿®å¤4ï¼šBaziServiceä½¿ç”¨æ–°æ–¹æ³•**

#### ä¿®å¤å¤§è¿æœŸé—´æµå¹´è®¡ç®—
```typescript
// ä¿®å¤å‰
const daYunLiuNian = LiuNianCalculator.calculateLiuNianByYearRange(
  daYun.startYear,
  endYear,
  birthYear,
  dayStem
);

// ä¿®å¤å
const fourPillarInfo = {
  yearStem: eightChar.getYearGan(),
  yearBranch: eightChar.getYearZhi(),
  monthStem: eightChar.getMonthGan(),
  monthBranch: eightChar.getMonthZhi(),
  dayBranch: eightChar.getDayZhi(),
  hourStem: eightChar.getTimeGan(),
  hourBranch: eightChar.getTimeZhi()
};
const daYunLiuNian = LiuNianCalculator.calculateLiuNianByYearRangeWithFourPillar(
  daYun.startYear,
  endYear,
  birthYear,
  dayStem,
  fourPillarInfo
);
```

### **ä¿®å¤5ï¼šå®Œå–„å‚æ•°é€‚é…é€»è¾‘**

#### ç»†åˆ†ç©ºäº¡å‚æ•°é€‚é…
```typescript
case 'å¹´ç©ºäº¡':
  // éœ€è¦å¹´å¹²ã€å¹´æ”¯
  if (yearStem && yearBranch) {
    return algorithm(yearStem, yearBranch, branch);
  }
  console.log(`âš ï¸ å¹´ç©ºäº¡è®¡ç®—è·³è¿‡ï¼šç¼ºå°‘å¹´æŸ±ä¿¡æ¯`);
  return false;

case 'æœˆç©ºäº¡':
  // éœ€è¦æœˆå¹²ã€æœˆæ”¯
  if (monthStem && monthBranch) {
    return algorithm(monthStem, monthBranch, branch);
  }
  console.log(`âš ï¸ æœˆç©ºäº¡è®¡ç®—è·³è¿‡ï¼šç¼ºå°‘æœˆæŸ±ä¿¡æ¯`);
  return false;

case 'æ—¶ç©ºäº¡':
  // éœ€è¦æ—¶å¹²ã€æ—¶æ”¯
  if (hourStem && hourBranch) {
    return algorithm(hourStem, hourBranch, branch);
  }
  console.log(`âš ï¸ æ—¶ç©ºäº¡è®¡ç®—è·³è¿‡ï¼šç¼ºå°‘æ—¶æŸ±ä¿¡æ¯`);
  return false;
```

## ğŸ“Š **ä¿®å¤æ•ˆæœå¯¹æ¯”**

### **ä¿®å¤å‰çš„é—®é¢˜**
- âŒ ç»†åˆ†ç©ºäº¡åœ¨æµå¹´ã€å¤§è¿ä¸­å®Œå…¨ä¸æ˜¾ç¤º
- âŒ åªèƒ½çœ‹åˆ°åŸºæœ¬çš„"ç©ºäº¡"ï¼Œçœ‹ä¸åˆ°"å¹´ç©ºäº¡"ã€"æœˆç©ºäº¡"ã€"æ—¶ç©ºäº¡"
- âŒ å‚æ•°ä¼ é€’é“¾æ¡æ–­è£‚ï¼Œå››æŸ±ä¿¡æ¯æ— æ³•åˆ°è¾¾ç®—æ³•å±‚
- âŒ ç”¨æˆ·æ— æ³•è·å¾—ç²¾ç¡®çš„ç©ºäº¡åˆ†æ

### **ä¿®å¤åçš„æ•ˆæœ**
- âœ… ç»†åˆ†ç©ºäº¡å¯ä»¥åœ¨æµå¹´ã€å¤§è¿ä¸­æ­£ç¡®æ˜¾ç¤º
- âœ… å¯ä»¥çœ‹åˆ°å¹´ç©ºã€æœˆç©ºã€æ—¥ç©ºã€æ—¶ç©ºç­‰è¯¦ç»†ä¿¡æ¯
- âœ… å‚æ•°ä¼ é€’é“¾æ¡å®Œæ•´ï¼Œå››æŸ±ä¿¡æ¯æ­£ç¡®ä¼ é€’
- âœ… ç”¨æˆ·å¯ä»¥è·å¾—ç²¾ç¡®çš„ç©ºäº¡åˆ†æå’ŒåŒ–è§£æŒ‡å¯¼

### **å‘åå…¼å®¹æ€§**
- âœ… æ‰€æœ‰æ–°å¢å‚æ•°éƒ½æ˜¯å¯é€‰çš„
- âœ… ç°æœ‰è°ƒç”¨æ–¹å¼ä»ç„¶æœ‰æ•ˆ
- âœ… ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
- âœ… ä¿ç•™äº†åŸæœ‰çš„calculateLiuNianByYearRangeæ–¹æ³•

## ğŸ”§ **äººå·¥æ ¸æŸ¥æ–¹æ³•**

### **å¿«é€ŸéªŒè¯å‘½ä»¤**
```bash
# 1. æ£€æŸ¥æ¥å£å®šä¹‰
grep -A 10 "yearStem.*yearBranch.*monthStem" src/services/bazi/shensha/

# 2. æ£€æŸ¥å››æŸ±ä¿¡æ¯ä¼ é€’
grep -A 5 "fourPillarInfo.*=" src/services/bazi/

# 3. æ£€æŸ¥ç¥ç…è®¡ç®—è°ƒç”¨
grep -A 3 "calculateDaYunShenSha.*fourPillarInfo" src/services/bazi/
grep -A 3 "calculateLiuNianShenSha.*fourPillarInfo" src/services/bazi/

# 4. éªŒè¯ç¼–è¯‘
npm run build
```

### **æ ¸æŸ¥æ¸…å•**
- [ ] PillarShenShaParamsåŒ…å«yearStemã€yearBranchã€monthStemã€monthBranchã€hourStemã€hourBranch
- [ ] ShenShaCalculationParamsåŒ…å«dayBranchã€hourStemã€hourBranch
- [ ] DaYunCalculatorä¼ é€’fourPillarInfoç»™calculateDaYunShenSha
- [ ] LiuNianCalculatorä¼ é€’fourPillarInfoç»™calculateLiuNianShenSha
- [ ] BaziServiceä½¿ç”¨calculateLiuNianByYearRangeWithFourPillar
- [ ] ç»†åˆ†ç©ºäº¡çš„å‚æ•°é€‚é…æ­£ç¡®
- [ ] ç¼–è¯‘æ— é”™è¯¯

### **æµ‹è¯•éªŒè¯**
1. **æ‰“å¼€å…«å­—åˆ†æç•Œé¢**
2. **æŸ¥çœ‹å¤§è¿è¡¨æ ¼**ï¼šåº”è¯¥èƒ½çœ‹åˆ°å¹´ç©ºäº¡ã€æœˆç©ºäº¡ã€æ—¶ç©ºäº¡ç­‰
3. **æŸ¥çœ‹æµå¹´è¡¨æ ¼**ï¼šåº”è¯¥èƒ½çœ‹åˆ°ç»†åˆ†ç©ºäº¡ä¿¡æ¯
4. **æ£€æŸ¥æ§åˆ¶å°**ï¼šä¸åº”è¯¥æœ‰"ç¼ºå°‘å¹´æŸ±ä¿¡æ¯"ç­‰è­¦å‘Š

## ğŸ¯ **ä½¿ç”¨æ•ˆæœ**

### **ç°åœ¨æ‚¨å¯ä»¥çœ‹åˆ°**
1. **å¹´ç©ºäº¡**ï¼šåœ¨å¤§è¿ã€æµå¹´ä¸­æ˜¾ç¤ºï¼Œè¡¨ç¤ºç¥–ä¸šè™šç©ºï¼Œæ—©å¹´ç¯å¢ƒå˜åŠ¨
2. **æœˆç©ºäº¡**ï¼šåœ¨å¤§è¿ã€æµå¹´ä¸­æ˜¾ç¤ºï¼Œè¡¨ç¤ºçˆ¶æ¯ç¼˜è–„ï¼Œéœ€ç‹¬ç«‹å‘å±•
3. **æ—¥ç©ºäº¡**ï¼šåœ¨å¤§è¿ã€æµå¹´ä¸­æ˜¾ç¤ºï¼Œè¡¨ç¤ºè‡ªèº«è™šç©ºï¼Œæ€§æ ¼é£˜å¿½
4. **æ—¶ç©ºäº¡**ï¼šåœ¨å¤§è¿ã€æµå¹´ä¸­æ˜¾ç¤ºï¼Œè¡¨ç¤ºå­å¥³ç¼˜è–„ï¼Œæ™šå¹´å­¤ç‹¬

### **æ¯ç§ç©ºäº¡éƒ½æä¾›**
- **è¯¦ç»†çš„å½±å“è¯´æ˜**ï¼šå…·ä½“çš„äººç”Ÿå½±å“åˆ†æ
- **é’ˆå¯¹æ€§çš„åŒ–è§£æ–¹æ³•**ï¼šä¸“é—¨çš„åŒ–è§£ç­–ç•¥å’Œç‰©å“
- **æœ€ä½³åŒ–è§£æ—¶æœº**ï¼šæŒ‡å¯¼ä½•æ—¶è¿›è¡ŒåŒ–è§£
- **æ³¨æ„äº‹é¡¹æŒ‡å¯¼**ï¼šå…·ä½“çš„è¡Œä¸ºæ”¹å–„å»ºè®®

## âœ… **éªŒè¯ç»“æœ**

- âœ… **TypeScriptç¼–è¯‘**ï¼šæ— é”™è¯¯æ— è­¦å‘Š
- âœ… **ESLintæ£€æŸ¥**ï¼šä»£ç è§„èŒƒé€šè¿‡
- âœ… **æ„å»ºæˆåŠŸ**ï¼šæ‰€æœ‰æ¨¡å—æ­£å¸¸æ„å»º
- âœ… **å‚æ•°ä¼ é€’**ï¼šå››æŸ±ä¿¡æ¯æ­£ç¡®ä¼ é€’åˆ°ç®—æ³•å±‚
- âœ… **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½

è¿™æ¬¡å®Œæ•´çš„æµç¨‹ä¿®å¤å½»åº•è§£å†³äº†ç»†åˆ†ç©ºäº¡åœ¨æµå¹´ã€å¤§è¿ä¸­ä¸æ˜¾ç¤ºçš„é—®é¢˜ã€‚ç°åœ¨ç¥ç…ç³»ç»Ÿå¯ä»¥æä¾›æœ€å®Œæ•´ã€æœ€å‡†ç¡®çš„ç©ºäº¡åˆ†æï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿç²¾ç¡®äº†è§£å„ä¸ªäººç”Ÿé¢†åŸŸçš„ç©ºäº¡æƒ…å†µå¹¶è·å¾—é’ˆå¯¹æ€§çš„åŒ–è§£æŒ‡å¯¼ï¼
